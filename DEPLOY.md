# Деплой KARTO (Timeweb Cloud)

## Важно: только Backend Apps

Next.js с SSR и API-маршрутами нужно разворачивать в **Backend Apps**, а не во Frontend Apps. Во Frontend Apps нет Node.js-сервера, запросы к `/_next/*` отдают HTML — из-за этого сайт без стилей и с ошибкой «Unexpected token '<'». Создай приложение в разделе **Backend Apps** и привяжи к нему репозиторий и домен.

## 1. Проверь next.config

В проекте должен быть **без** строки `output: 'export'`.  
Сейчас используется `output: "standalone"` — так и должно быть для Node.js на Timeweb.  
Режим `export` даёт статику в `/out`, тогда сервер не отдаёт JS/CSS — из-за этого и бывает ошибка «Unexpected token '<'».

## 2. Настройки в панели Timeweb (App Platform)

- **Директория сборки (Output / корень приложения):** строго корень репозитория (часто поле пустое или `.`). Не менять на `out` или что-то другое — нужна сборка в `.next`.
- **Команда сборки:** `npm run build`
- **Команда запуска:** `npm run start` или `npm run start:prod` (оба запускают Next.js; если панель подставляет NestJS-шаблон с `start:prod` — теперь скрипт есть).

**Переменные окружения (обязательно для Backend Apps):**
- **PORT** — должна быть задана панелью (например 3000 или 8080). Если нет — добавь вручную, например `PORT=3000`.
- **HOSTNAME** — добавь `HOSTNAME=0.0.0.0`, чтобы сервер слушал на всех интерфейсах (иначе платформа может не достучаться до приложения и отправит SIGTERM).
- **NEXT_CACHE_DIR** — добавь `NEXT_CACHE_DIR=/tmp`, чтобы кэш изображений писался в /tmp (иначе возможна ошибка «EACCES: permission denied» для `.next/cache`).
- **NEXT_PUBLIC_SUPABASE_URL** и **NEXT_PUBLIC_SUPABASE_ANON_KEY** — обязательны для входа и регистрации. Без них появится ошибка «Invalid API key». Возьми значения из Supabase Dashboard → Project Settings → API.
- Остальные переменные (Replicate и т.д.) — как в `.env.local`.

**Путь проверки состояния:** оставь пустым или укажи `/`. Если указан неверный путь, платформа может считать приложение мёртвым и завершать процесс (SIGTERM).

**Зависимости (системные пакеты):** в настройках приложения в разделе «Зависимости» (или «Дополнительные пакеты» / «System packages») добавь **ca-certificates**. Без него в контейнере нет файла `/etc/ssl/certs/ca-certificates.crt`, из‑за чего все HTTPS-запросы из приложения падают с «fetch failed». Пакет ставится через `apt install` при сборке.

## 3. Пересборка

После правок в репозитории и в настройках приложения:

1. В приложении Karto нажми **«Пересобрать»** / **Deploy**.
2. Выбери вариант **«Сбросить кэш и собрать»**, чтобы старые артефакты не мешали.

## 4. Если сайт всё ещё без стилей (Unexpected token '<')

Значит, запросы к `/_next/static/...` не доходят до Node или сервер отдаёт HTML вместо JS/CSS. Тогда:

- Убедись, что в настройках домена/прокси **все** запросы к домену идут в Node-приложение (нет правил, которые отдают только главную или режут `/_next/*`).
- В поддержку Timeweb можно написать: «Приложение Next.js: нужно, чтобы все запросы (включая `/_next/static/*`) проксировались в Node-приложение, а не отдавался HTML».

## 5. 502 Bad Gateway и SIGTERM в логах

Если в браузере **502 Bad Gateway**, а в логах приложение стартует («Ready in Xms») и затем падает с **SIGTERM** — платформа принудительно завершает процесс. Частые причины:

1. **Нет или неверный PORT** — платформа стучится на другой порт, не получает ответ → считает приложение мёртвым → SIGTERM. В переменных должен быть задан PORT (тот же, на который платформа проксирует).
2. **Приложение слушает только localhost** — добавь переменную **HOSTNAME=0.0.0.0**.
3. **Не проходит проверка здоровья** — путь проверки состояния оставь пустым или укажи `/`; убедись, что главная страница отдаётся на том же порте.

Если после добавления PORT и HOSTNAME=0.0.0.0 ошибка остаётся — в поддержку: «Backend App на Next.js: приложение стартует (Ready), затем процесс получает SIGTERM и завершается. Заданы PORT и HOSTNAME=0.0.0.0. Подскажите, какой порт использует платформа для маршрутизации и не завершает ли платформа процесс из‑за проверки здоровья или таймаута?»

## 6. 404 на статику (/_next/static, картинки /gallery/)

Если после «восстановления доступности» в консоли браузера много 404 на `/_next/static/chunks/...` и на `/gallery/...`:

- **Чанки и CSS:** в сборку добавлен шаг `scripts/copy-standalone.js`: после `next build` копируются `public` и `.next/static` в `.next/standalone`, чтобы standalone-сервер их отдавал. Запуши изменения, сделай **пересборку с очисткой кэша** на Timeweb.
- **Картинки /gallery/:** файлы должны лежать в репозитории в `public/gallery/` (card-1.png … card-8.png, for-gallery.jpg и др. — список в `public/gallery/README.md`). Если их нет в репо — добавь, закоммить и пересобери приложение.

## 7. Исходящие запросы (Supabase, KIE, Replicate, OpenRouter) — «всё не работает» на сервере

Приложение с сервера Timeweb обращается к внешним API. Если эти запросы блокируются или не доходят, получаешь:
- **Connect Timeout** / **fetch failed** в логах;
- не работает вход (Supabase);
- не работает распознавание фото (Replicate);
- не генерируются карточки (KIE AI);
- не работают описания и концепции (OpenRouter).

**Что проверить в панели Timeweb:**

1. **Приватная сеть (шаг при создании приложения).**  
   Если при создании Backend App ты выбирал **приватную сеть (VPC)** — из такой сети выход в интернет возможен только через NAT. Убедись, что у этой сети настроен NAT (см. [NAT в Timeweb](https://timeweb.cloud/docs/vpc/nat)).  
   Либо создай приложение **без** приватной сети (оставить поле пустым), тогда исходящий доступ обычно есть по умолчанию.

2. **Firewall (FWaaS).**  
   Если к приложению или серверу привязана группа правил Firewall с типом **«Разрешающие» (whitelist)** — по умолчанию разрешён только явно указанный трафик. Нужно добавить правило: **исходящий (egress) HTTPS, порт 443**, на любые адреса (или на домены ниже).

3. **Домены, к которым должно быть разрешено исходящее HTTPS (443):**
   - `*.supabase.co` (например `xxxx.supabase.co`) — база и авторизация;
   - `api.replicate.com` — распознавание изображений;
   - `api.kie.ai` — генерация карточек товара;
   - `kieai.redpandaai.co` — загрузка референсов для KIE;
   - `openrouter.ai` — генерация текста (описания, концепции).

**Если сам не разберёшься — напиши в поддержку Timeweb.** Готовый текст запроса лежит в файле **TIMEWEB_SUPPORT.md** в корне проекта — скопируй его в тикет.
