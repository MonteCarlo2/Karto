# Как проверить, почему не начисляются генерации после оплаты

## 1. Какие логи смотреть

Ты прислал **логи деплоя** (сборка, контейнер). Нужны **логи приложения в момент оплаты**.

- В Timeweb открой приложение → вкладка **«Логи»** или **«Логи приложения»** (не «Логи деплоя»).
- Сделай тестовую оплату (5 ₽, 10 генераций).
- Сразу после оплаты обнови логи и ищи строки:
  - `[PAYMENT WEBHOOK] === POST received ===` — запрос от ЮKassa дошёл до сервера.
  - `[PAYMENT WEBHOOK] credit: ... + 10` — разобрали платёж, собираемся начислять.
  - `[PAYMENT CREDIT] UPDATE ok` или `[PAYMENT CREDIT] INSERT ok` — запись в БД прошла.
  - `[PAYMENT CONFIRM]` — сработало подтверждение при возврате на сайт.

Если **нет ни одной** строки `[PAYMENT WEBHOOK]` в момент оплаты — вебхук до приложения не доходит (проверь URL в ЮKassa и что приложение запущено и не падает).

---

## 2. Проверка в Supabase после оплаты

1. **Таблица `payment_processed`**  
   Открой в Supabase → Table Editor → `payment_processed`.  
   После оплаты должна появиться **новая строка** с `payment_id` (длинный идентификатор от ЮKassa).  
   - Если строки **нет** — вебхук не сработал или не дошёл до вставки в эту таблицу.  
   - Если **есть** — вебхук сработал, смотри следующий шаг.

2. **Таблица `user_subscriptions`**  
   Найди свою строку по `user_id` (как в профиле/логине) и `plan_type = creative`.  
   Посмотри поле **`plan_volume`**: изменилось ли оно после оплаты (прибавилось 10)?  
   - Если **не изменилось** — в логах приложения ищи `[PAYMENT CREDIT] UPDATE error` или `INSERT error` (там будет причина от БД).  
   - Если **изменилось** — начисление прошло; проблема может быть в отображении в профиле (кэш, другой user_id и т.п.).

---

## 3. Кратко

| Где смотреть | Что значит |
|--------------|-----------|
| Логи приложения: есть `[PAYMENT WEBHOOK] === POST received ===` | Вебхук дошёл до сервера. |
| Логи: есть `[PAYMENT CREDIT] UPDATE ok` или `INSERT ok` | Запись в `user_subscriptions` прошла. |
| В Supabase в `payment_processed` есть новый `payment_id` | Платёж обработан (идемпотентность). |
| В Supabase в `user_subscriptions` вырос `plan_volume` по твоему user_id | Начисление в БД есть; искать баг в профиле/запросе подписки. |

**Важно:** После возврата с ЮKassa на `/profile?payment=success` фронтенд передаёт `payment_id` в теле запроса к `/api/payment/confirm` (из cookie `karto_pending_payment_id`). Если в логах видишь `[PAYMENT CONFIRM] payment_id not found` — значит ни cookie, ни запись в `pending_payment` не найдены; проверь, что при создании платежа в таблице `pending_payment` появляется строка (если нет — выполни скрипт из `APPLY_PAYMENT_TABLES.sql`).
