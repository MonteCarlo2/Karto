# Настройка Supabase для KARTO

## Шаг 1: Создание проекта в Supabase

1. Зайдите на https://supabase.com/
2. Создайте новый проект
3. Выберите регион (рекомендуется ближайший к вашим серверам)
4. Дождитесь создания проекта

## Шаг 2: Получение ключей

1. В проекте Supabase перейдите в **Settings** → **API**
2. Скопируйте:
   - **Project URL** → это `SUPABASE_URL`
   - **service_role key** (секретный ключ) → это `SUPABASE_SERVICE_ROLE_KEY`
   - ⚠️ **ВАЖНО**: Используйте именно `service_role` ключ, НЕ `anon` ключ!

## Шаг 3: Настройка переменных окружения

Создайте или обновите файл `.env.local` в корне проекта:

```env
# Supabase (обязательно)
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here

# Replicate (уже должен быть)
REPLICATE_API_TOKEN=r8_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

⚠️ **КРИТИЧЕСКИ ВАЖНО ДЛЯ БЕЗОПАСНОСТИ:**
- Никогда не коммитьте `.env.local` в git (он уже в `.gitignore`)
- Никогда не используйте `service_role` ключ на клиенте
- Все операции с Supabase выполняются только через серверные API routes

## Шаг 4: Создание схемы базы данных

1. В Supabase Dashboard перейдите в **SQL Editor**
2. Откройте файл `supabase-schema.sql` из корня проекта
3. Скопируйте весь SQL код
4. Вставьте в SQL Editor и выполните (Run)

Это создаст:
- Таблицы: `product_sessions`, `understanding_data`, `description_data`
- Индексы для быстрого поиска
- Row Level Security (RLS) политики
- Триггеры для автоматического обновления `updated_at`

## Шаг 5: Проверка настройки

После настройки проверьте:

1. ✅ Таблицы созданы (в **Table Editor** должны быть видны 3 таблицы)
2. ✅ RLS включен (в настройках таблиц должно быть "RLS enabled")
3. ✅ Переменные окружения установлены
4. ✅ Приложение запускается без ошибок

## Безопасность

### Что уже настроено:
- ✅ Все API ключи только в `.env.local` (не коммитятся)
- ✅ Все операции с БД через серверные API routes
- ✅ RLS политики включены для всех таблиц
- ✅ `service_role` ключ используется только на сервере

### Дополнительные рекомендации:
- Регулярно проверяйте логи Supabase на подозрительную активность
- Используйте разные проекты Supabase для dev и production
- Ограничьте доступ к `service_role` ключу только разработчикам

## Устранение проблем

### Ошибка "SUPABASE_URL не установлен"
- Проверьте, что `.env.local` существует и содержит `SUPABASE_URL`
- Перезапустите dev сервер после изменения `.env.local`

### Ошибка "permission denied"
- Проверьте, что используете `service_role` ключ, а не `anon` ключ
- Проверьте, что RLS политики настроены правильно

### Данные не сохраняются
- Проверьте логи в Supabase Dashboard → Logs
- Проверьте, что таблицы созданы и RLS политики активны
- Проверьте консоль браузера на ошибки
