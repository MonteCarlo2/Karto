# Текст запроса в поддержку Timeweb Cloud

## КРИТИЧНО: если приложение получает SIGTERM сразу после «Ready»

В логах видно: `✓ Ready in 148ms`, затем `npm error signal SIGTERM`. Платформа убивает процесс — из‑за этого вебхук и confirm не успевают дописать в БД (payment_processed, user_subscriptions).

**Что сделать в панели Timeweb:**
1. **Путь проверки состояния** — обязательно укажи **`/api/health`** (именно этот путь, не `/` и не `/health`).
2. Если есть настройка **«Время ожидания проверки»** / **Startup grace period** — поставь не меньше **60** секунд, чтобы Next.js успел подняться.
3. Убедись, что тип приложения — **Next.js** или **Node.js**, а не NestJS.

Проверка: после деплоя открой в браузере **https://karto.pro/api/health** — должен быть ответ `{"ok":true}` и статус 200. Если платформа стучится на другой путь и не получает 200, она считает приложение мёртвым и шлёт SIGTERM.

**Тип приложения:** в настройках сборки выбери фреймворк **Next.js** (не NestJS). Команда сборки: `npm run build`, запуск: по умолчанию для Next.js.

---

**Куда писать:** панель Timeweb Cloud → Поддержка → Создать обращение (или https://timeweb.cloud/my/support/help-question).

Скопируй блок ниже в поле сообщения.

---

**Тема:** Backend App не может достучаться до внешних API (исходящий HTTPS)

Добрый день.

У меня развёрнуто Backend-приложение (App Platform, тип Backend) — Next.js. Оно должно обращаться к внешним сервисам по HTTPS. С локального компьютера всё работает, а с сервера Timeweb запросы не проходят: в логах приложения вижу **Connect Timeout** и **fetch failed** при обращении к этим доменам.

Нужно, чтобы с сервера/контейнера, на котором крутится приложение, был разрешён **исходящий HTTPS (порт 443)** до следующих хостов:

- **\*.supabase.co** (любые поддомены, например xxxx.supabase.co) — база данных и авторизация;
- **api.replicate.com** — API распознавания изображений;
- **api.kie.ai** — API генерации изображений;
- **kieai.redpandaai.co** — загрузка файлов для API генерации;
- **openrouter.ai** — API генерации текста.

Подскажите, пожалуйста:
1. Блокируется ли исходящий трафик с Backend Apps по умолчанию или есть ограничения?
2. Если к приложению привязан Firewall или приватная сеть — что нужно настроить (NAT, правила egress), чтобы исходящие HTTPS-запросы к перечисленным доменам проходили?

Приложение: [укажи название приложения в панели, например «Karto»].  
Домен: karto.pro (если привязан).

Спасибо.

---

После ответа поддержки можно обновить этот файл или DEPLOY.md, чтобы записать, что именно нужно было включить (например, «добавить правило egress HTTPS в Firewall»).

---

## Дополнительная диагностика (если поддержка сказала «ограничений нет»)

Поддержка могла проверить доступ с **хоста** (curl от root). Приложение же может работать **в контейнере** с другой сетью.

1. Задеплой текущий код (есть маршрут `GET /api/network-check`).
2. Открой в браузере: **https://karto.pro/api/network-check** (или твой домен).
3. В ответе будет JSON: по каждому сервису — достижим ли он **из процесса приложения** (тот же контейнер, что и остальные API).
4. Если там есть `ok: false` и `error: "fetch failed"` / таймаут — значит из контейнера доступа нет, а с хоста есть. Тогда отправь этот JSON в поддержку Timeweb и попроси: «Проверка с хоста (curl) проходит, а из процесса приложения (GET /api/network-check) — нет. Нужен ли исходящий доступ именно из контейнера Backend App и как его включить?»
