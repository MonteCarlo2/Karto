# Решение проблемы "Error sending confirmation email"

## Проблема

При регистрации появляется ошибка **"Error sending confirmation email"** или ошибка 500 в консоли.

Это означает, что Supabase не может отправить письмо через ваш SMTP сервер.

---

## Решение для Рамблера / @ro.ru

### ⚠️ ВАЖНО: Если у вас email @ro.ru

Если ваш email заканчивается на `@ro.ru` (а не `@rambler.ru`), SMTP настройки могут отличаться!

### Шаг 1: Проверьте настройки SMTP в Supabase

Зайдите в **Supabase Dashboard** → **Settings** → **Authentication** → **SMTP Settings** и проверьте:

1. **"Enable custom SMTP"** должен быть **включен** (зелёный переключатель)

2. **Host:** 
   - Для `@rambler.ru`: `smtp.rambler.ru`
   - Для `@ro.ru`: Попробуйте `smtp.rambler.ru` или `smtp.mail.ru` (так как @ro.ru может использовать ту же инфраструктуру)

3. **Port:** Попробуйте оба варианта:
   - `465` (SSL) - **попробуйте сначала этот**
   - `587` (TLS) - если 465 не работает

4. **Username:** `ваш-email@ro.ru` (полный email адрес, как он есть)

5. **Password:** 
   - **Проблема может быть здесь!** Убедитесь, что:
     - Пароль скопирован полностью, без пробелов в начале/конце
     - Если есть пароль для внешних приложений - используйте его
     - Если используете обычный пароль - убедитесь, что он правильный
   - **Попробуйте пересоздать пароль** в настройках почты

6. **Sender Email:** `ваш-email@ro.ru` (тот же email, точно как в Username)

7. **Sender Name:** `KARTO`

### Шаг 2: Проверьте логи в Supabase

1. Зайдите в **Supabase Dashboard** → **Logs** → **Auth Logs**
2. Найдите последнюю ошибку
3. Посмотрите детали ошибки - там будет указано, что именно не так

### Шаг 3: Частые проблемы и решения

#### Проблема 1: "Authentication failed" или ошибка 500

**Решение:**
- **Проверьте пароль:** Убедитесь, что пароль правильный и скопирован полностью
- **Проверьте Username:** Должен быть полный email (например, `karto.help@ro.ru`)
- **Попробуйте другой порт:** Если используете 465, попробуйте 587 (и наоборот)
- **Для @ro.ru:** Попробуйте использовать `smtp.mail.ru` вместо `smtp.rambler.ru` (так как @ro.ru может использовать инфраструктуру Mail.ru)
- **Проверьте логи:** Supabase Dashboard → Logs → Auth Logs - там будет детальная ошибка

#### Проблема 2: "Connection timeout" или "Connection refused"

**Решение:**
- Попробуйте порт `587` вместо `465` (или наоборот)
- Проверьте, что Host правильный: `smtp.rambler.ru` (не `smtp.rambler.com`)

#### Проблема 3: "SSL/TLS error"

**Решение:**
- Для порта `465` используйте SSL
- Для порта `587` используйте TLS
- Supabase обычно определяет это автоматически

#### Проблема 4: Письма всё равно не отправляются

**Решение:**
- Проверьте, что двухфакторная аутентификация включена в настройках Рамблера
- Попробуйте временно отключить SMTP в Supabase и включить стандартный (чтобы проверить, что проблема именно в SMTP)
- Создайте новую почту на Mail.ru специально для отправки писем (там точно работает)

---

## Альтернативное решение: Использовать Mail.ru

Если Рамблер не работает, создайте почту на Mail.ru:

1. Зарегистрируйте `karto.help@mail.ru`
2. Создайте пароль для внешних приложений: https://account.mail.ru/user/2-step-auth/passwords
3. Настройте в Supabase:
   ```
   Host: smtp.mail.ru
   Port: 465
   Username: karto.help@mail.ru
   Password: [пароль для внешних приложений]
   Sender Email: karto.help@mail.ru
   Sender Name: KARTO
   ```

---

## Проверка работы

После настройки:

1. Сохраните настройки в Supabase
2. Попробуйте зарегистрировать тестового пользователя
3. Проверьте логи в Supabase: **Logs** → **Auth Logs**
4. Если ошибок нет - письмо должно прийти на указанный email

---

## Если ничего не помогает

1. **Временно отключите Custom SMTP** в Supabase
2. Письма будут отправляться от `noreply@mail.app.supabase.io` (стандартный Supabase)
3. Это позволит проверить, что регистрация работает
4. Потом можно вернуться к настройке SMTP
