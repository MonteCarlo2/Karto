# Миграция: Сохранение промежуточного состояния визуала

## Проблема
При обновлении страницы на этапе ВИЗУАЛ терялось состояние:
- Выбранная карточка (selectedCardIndex)
- Сгенерированные карточки (generatedCards)
- Режим серии (isSeriesMode)

Это приводило к тому, что пользователь возвращался на экран генерации 4 карточек, даже если уже выбрал карточку и перешел в режим серии.

## Решение
Добавлено поле `visual_state` в таблицу `visual_data` для сохранения промежуточного состояния визуала.

## Инструкция по применению

1. **Откройте Supabase Dashboard** → **SQL Editor**

2. **Выполните SQL миграцию:**
   - Откройте файл `supabase-visual-state-migration.sql`
   - Скопируйте весь SQL код
   - Вставьте в SQL Editor
   - Нажмите **Run**

3. **Проверка:**
   - После выполнения миграции поле `visual_state` будет добавлено в таблицу `visual_data`
   - Все существующие записи получат значение `{}` по умолчанию

## Что изменилось

### База данных
- Добавлено поле `visual_state JSONB` в таблицу `visual_data`
- Поле хранит промежуточное состояние: `{ generatedCards, selectedCardIndex, isSeriesMode }`

### API
- `/api/supabase/save-results` - теперь сохраняет `visual_state`
- `/api/supabase/get-results` - теперь возвращает `visual_state`

### Фронтенд
- Состояние визуала автоматически сохраняется при изменении
- При загрузке страницы состояние восстанавливается из Supabase
- Пользователь продолжает с того места, где остановился

## Результат

✅ Поток правильно определяется как завершенный только если есть И визуал, И цена
✅ Состояние визуала сохраняется и восстанавливается при обновлении страницы
✅ Пользователь не теряет прогресс при обновлении страницы на этапе ВИЗУАЛ
