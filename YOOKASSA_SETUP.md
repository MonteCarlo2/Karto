# Подключение ЮKassa (Яндекс.Касса) для KARTO

В проекте оплата пока не реализована (работает бета: выбор тарифа без оплаты). Ниже — как подключить ЮKassa и что сделать перед рекламой в Telegram.

---

## 1. Кабинет ЮKassa

1. Зайди на [yookassa.ru](https://yookassa.ru) и войди в личный кабинет (или зарегистрируйся).
2. Подключи приём платежей для своего магазина (если ещё не подключен).
3. В настройках получи:
   - **shopId** — идентификатор магазина;
   - **Секретный ключ** — в разделе «Настройки» → «Ключи API» (создай ключ, если нет).

---

## 2. Переменные окружения

В `.env.local` (и в настройках Vercel/Timeweb) добавь:

```env
YOOKASSA_SHOP_ID=ваш_shop_id
YOOKASSA_SECRET_KEY=ваш_секретный_ключ
```

Для тестов можно включить тестовый режим в кабинете ЮKassa (тестовые карты и т.д.).

---

## 3. Логика оплаты в KARTO

Сейчас на главной при нажатии «Выбрать тариф» вызывается `POST /api/subscription/select` — тариф сохраняется **без оплаты**.

Чтобы включить реальную оплату:

1. **Создание платежа**  
   Новый API (например `POST /api/payment/create`):
   - принимает: `mode` (0 = Поток, 1 = Свободное творчество), `tariffIndex` (0, 1, 2);
   - считает сумму по тарифам (Поток: 299 / 1190 / 2990 ₽, Свободное творчество: 249 / 590 / 1490 ₽);
   - создаёт платёж в ЮKassa через их API ([создание платежа](https://yookassa.ru/developers/api#create_payment));
   - в `metadata` передаёт `user_id`, `mode`, `tariffIndex`, чтобы после оплаты записать подписку;
   - возвращает клиенту `confirmation_url` — на него нужно перенаправить пользователя.

2. **После оплаты**  
   - **Webhook**: в кабинете ЮKassa укажи URL уведомлений, например `https://ваш-домен.ru/api/payment/webhook`. В обработчике при статусе `payment.succeeded` — обновить `user_subscriptions` (как сейчас в `/api/subscription/select`: записать/обновить запись по `user_id`, `plan_type`, `plan_volume`, `period_start`).
   - **Return URL**: при создании платежа укажи `return_url`, например `https://ваш-домен.ru/profile?payment=success` — страница «Спасибо, оплата прошла».

3. **Чек 54-ФЗ**  
   В политике указано: чек формируется через «Мой Налог». Это либо отдельная интеграция с сервисом, либо настройка в ЮKassa (если они отдают чеки). Нужно проверить в кабинете ЮKassa раздел про чеки и при необходимости подключить «Мой Налог» отдельно.

---

## 4. Краткий чек-лист перед рекламой в Telegram

- [ ] ЮKassa: магазин подключён, есть **shopId** и **секретный ключ**.
- [ ] В проекте: добавлены `YOOKASSA_SHOP_ID` и `YOOKASSA_SECRET_KEY` в `.env.local` и на проде.
- [ ] Реализован `POST /api/payment/create` (создание платежа, возврат `confirmation_url`).
- [ ] На главной: кнопка «Выбрать тариф» ведёт на оплату (вызов create → редирект на `confirmation_url`), а не на бесплатное сохранение тарифа (или оставь бета только для теста).
- [ ] Реализован `POST /api/payment/webhook` — при успешной оплате обновляется `user_subscriptions`.
- [ ] Настроен URL уведомлений в кабинете ЮKassa на этот webhook.
- [ ] Задан `return_url` при создании платежа (страница «Оплата прошла» / профиль).
- [ ] По необходимости: чеки 54-ФЗ (Мой Налог или настройки ЮKassa).
- [ ] Проверка: тестовый платёж от выбора тарифа до появления подписки в профиле.

После этого можно запускать рекламу в Telegram: ссылка на сайт и призыв оформить тариф — пользователь попадёт на оплату и после успешного платежа получит доступ по подписке.
