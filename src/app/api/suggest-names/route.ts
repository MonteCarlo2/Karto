import { NextRequest, NextResponse } from "next/server";
import { getReplicateClient } from "@/lib/services/replicate";

export async function POST(request: NextRequest) {
  try {
    const { text } = await request.json();

    if (!text || typeof text !== "string") {
      return NextResponse.json(
        { error: "–¢–µ–∫—Å—Ç –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω" },
        { status: 400 }
      );
    }

    const words = text.trim().split(/\s+/).filter(w => w.length > 0);
    if (words.length === 0 || words.length > 4) {
      return NextResponse.json({ suggestions: [] });
    }

    console.log("üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è:", text);

    const replicate = getReplicateClient();
    
    const prompt = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞: "${text}"

–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –¥–æ–ø–æ–ª–Ω–∏—Ç—å —ç—Ç–æ –Ω–∞—á–∞–ª–æ –¥–æ –ø–æ–ª–Ω–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞, –¥–æ–±–∞–≤–∏–≤ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏.

–í–ê–ñ–ù–û:
- –ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å "${text}" –∏ –±—ã—Ç—å –µ–≥–æ –ª–æ–≥–∏—á–µ—Å–∫–∏–º –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º
- –î–æ–±–∞–≤—å 1-3 —Å–ª–æ–≤–∞: –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ, –º–∞—Ç–µ—Ä–∏–∞–ª, —Ü–≤–µ—Ç, —Ä–∞–∑–º–µ—Ä, —Ç–∏–ø, –±—Ä–µ–Ω–¥ –∏–ª–∏ –¥—Ä—É–≥—É—é –≤–∞–∂–Ω—É—é —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É
- –ú–∞–∫—Å–∏–º—É–º 6 —Å–ª–æ–≤ –≤ –∏—Ç–æ–≥–æ–≤–æ–º –Ω–∞–∑–≤–∞–Ω–∏–∏
- –ù–∞–∑–≤–∞–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∏ –ø–æ–ø—É–ª—è—Ä–Ω—ã–º–∏ –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö (Ozon, Wildberries)
- –¢–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤, –ë–ï–ó –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∏ –æ–ø–∏—Å–∞–Ω–∏–π
- –†—É—Å—Å–∫–∏–π —è–∑—ã–∫
- –ö–∞–∂–¥–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏, –±–µ–∑ –Ω—É–º–µ—Ä–∞—Ü–∏–∏, —Ç–∏—Ä–µ, —Ç–æ—á–µ–∫

–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–π:
–ï—Å–ª–∏ –≤–≤–µ–¥–µ–Ω–æ "–ü—Ä–∏–Ω—Ç–µ—Ä" ‚Üí –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è:
–ü—Ä–∏–Ω—Ç–µ—Ä –¥–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞
–ü—Ä–∏–Ω—Ç–µ—Ä –ª–∞–∑–µ—Ä–Ω—ã–π —á–µ—Ä–Ω–æ-–±–µ–ª—ã–π
–ü—Ä–∏–Ω—Ç–µ—Ä —Å—Ç—Ä—É–π–Ω—ã–π —Ü–≤–µ—Ç–Ω–æ–π
–ü—Ä–∏–Ω—Ç–µ—Ä –¥–ª—è –æ—Ñ–∏—Å–∞

–ï—Å–ª–∏ –≤–≤–µ–¥–µ–Ω–æ "–ù–∞—É—à–Ω–∏–∫–∏" ‚Üí –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è:
–ù–∞—É—à–Ω–∏–∫–∏ –¥–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞
–ù–∞—É—à–Ω–∏–∫–∏ –±–µ—Å–ø—Ä–æ–≤–æ–¥–Ω—ã–µ Bluetooth
–ù–∞—É—à–Ω–∏–∫–∏ –∏–≥—Ä–æ–≤—ã–µ —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º
–ù–∞—É—à–Ω–∏–∫–∏ –¥–ª—è –º—É–∑—ã–∫–∏

–ï—Å–ª–∏ –≤–≤–µ–¥–µ–Ω–æ "–í–µ–¥—Ä–æ" ‚Üí –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è:
–í–µ–¥—Ä–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–µ 12 –ª–∏—Ç—Ä–æ–≤
–í–µ–¥—Ä–æ –ø–ª–∞—Å—Ç–∏–∫–æ–≤–æ–µ —Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω–æ–µ
–í–µ–¥—Ä–æ –¥–ª—è —Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–Ω–æ–µ
–í–µ–¥—Ä–æ —Å —Ä—É—á–∫–æ–π —É—Å–∏–ª–µ–Ω–Ω–æ–µ

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π 4 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è "${text}" (—Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏—è, –ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É):`;

    try {
      const output = await replicate.run(
        "meta/meta-llama-3-8b-instruct" as any,
        {
          input: {
            prompt: prompt,
            max_new_tokens: 150,
            temperature: 0.7,
            prompt_template: "<|begin_of_text|><|start_header_id|>system<|end_header_id|>\n\n–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ —Ç–æ–≤–∞—Ä–æ–≤.<|eot_id|><|start_header_id|>user<|end_header_id|>\n\n{prompt}<|eot_id|><|start_header_id|>assistant<|end_header_id|>\n\n",
          },
        }
      );

      let responseText = "";
      if (Array.isArray(output)) {
        responseText = output.join("");
      } else {
        responseText = String(output);
      }

      // –ü–∞—Ä—Å–∏–º –Ω–∞–∑–≤–∞–Ω–∏—è
      const suggestions = responseText
        .split(/\n+/)
        .map(line => line.replace(/^[\d.\-‚Ä¢*)\]\s]+/, "").trim())
        .filter(line => {
          if (!line || line.length < text.length + 3) return false;
          if (line.length > 60) return false;
          if (!line.toLowerCase().startsWith(text.toLowerCase())) return false;
          if (/(–∏–º–µ–µ—Ç|—Å—Ç–æ–∏—Ç|—è–≤–ª—è–µ—Ç—Å—è|–ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π)/i.test(line)) return false;
          return true;
        })
        .slice(0, 4);

      console.log("‚úÖ –ü–æ–¥—Å–∫–∞–∑–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã:", suggestions);

      return NextResponse.json({ suggestions });
    } catch (error: any) {
      console.error("‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–¥—Å–∫–∞–∑–æ–∫:", error);
      return NextResponse.json({ suggestions: [] });
    }
  } catch (error) {
    console.error("‚ùå –û—à–∏–±–∫–∞ API:", error);
    return NextResponse.json(
      { error: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–¥—Å–∫–∞–∑–æ–∫" },
      { status: 500 }
    );
  }
}
