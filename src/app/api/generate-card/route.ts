import { NextRequest, NextResponse } from "next/server";
import { buildProductCardPrompt, CARD_STYLES } from "@/lib/services/nanobanana";
import { generateWithKieAi } from "@/lib/services/kie-ai";
import { isSupabaseNetworkError } from "@/lib/supabase/network-error";
import { 
  downloadImage, 
  getPublicUrl,
  saveBase64Image,
} from "@/lib/services/image-processing";
import { generateDesignConcepts, DesignConcept } from "@/lib/services/style-concept-generator";
import path from "path";
import fs from "fs/promises";

/**
 * –£–º–Ω—ã–π –≤—ã–±–æ—Ä —Å—Ç–∏–ª—è –∏ —Ñ–æ–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
 * 
 * –ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢:
 * 1. –ë–µ—Ä–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ö–∞—à–ø–æ –ø–ª–∞—Å—Ç–∏–∫–æ–≤–æ–µ")
 * 2. –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤ –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞
 * 3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π:
 *    - –≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞: "—Ç–µ–ª–µ–≤–∏–∑–æ—Ä", "–º–æ–Ω–∏—Ç–æ—Ä", "–Ω–æ—É—Ç–±—É–∫" ‚Üí —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω—ã–π —Å—Ç–∏–ª—å
 *    - –†–∞—Å—Ç–µ–Ω–∏—è: "–∫–∞—à–ø–æ", "–≥–æ—Ä—à–æ–∫", "—Ä–∞—Å—Ç–µ–Ω–∏–µ" ‚Üí –ø—Ä–∏—Ä–æ–¥–Ω—ã–π —Å—Ç–∏–ª—å
 *    - –ú–µ–±–µ–ª—å: "—Å—Ç–æ–ª", "—Å—Ç—É–ª", "–¥–∏–≤–∞–Ω" ‚Üí –¥–æ–º–∞—à–Ω–∏–π —Å—Ç–∏–ª—å
 *    - –ò —Ç.–¥.
 * 4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–∏–ª—è –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
 * 
 * –ü–†–ò–ú–ï–†:
 * - –í—Ö–æ–¥: "–ö–∞—à–ø–æ –ø–ª–∞—Å—Ç–∏–∫–æ–≤–æ–µ —á–µ—Ä–Ω–æ–µ"
 * - –ù–∞—Ö–æ–¥–∏—Ç: "–∫–∞—à–ø–æ" ‚Üí –∫–∞—Ç–µ–≥–æ—Ä–∏—è "–†–∞—Å—Ç–µ–Ω–∏—è"
 * - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: "–ü—Ä–∏—Ä–æ–¥–Ω—ã–π —Å—Ç–∏–ª—å: —Å–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –ø—Ä–∏—Ä–æ–¥—ã..."
 */
function getSmartStyleForProduct(productName: string): string {
  const name = productName.toLowerCase();
  
  // –≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞ –∏ —Ç–µ—Ö–Ω–∏–∫–∞
  if (name.includes("—Ç–µ–ª–µ–≤–∏–∑–æ—Ä") || name.includes("–º–æ–Ω–∏—Ç–æ—Ä") || name.includes("—ç–∫—Ä–∞–Ω") || 
      name.includes("–Ω–æ—É—Ç–±—É–∫") || name.includes("–ø–ª–∞–Ω—à–µ—Ç") || name.includes("—Å–º–∞—Ä—Ç—Ñ–æ–Ω") ||
      name.includes("—Ç–µ–ª–µ—Ñ–æ–Ω") || name.includes("–∫–æ–º–ø—å—é—Ç–µ—Ä")) {
    return "–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω—ã–π —Å—Ç–∏–ª—å: —Ç–µ–º–Ω—ã–π –∏–ª–∏ —Å–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω —Å –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏, –Ω–µ–æ–Ω–æ–≤—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã, —Ñ—É—Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ç–µ—Ö–Ω–∏–∫–∏.";
  }
  
  // –ú–µ–±–µ–ª—å –∏ –∏–Ω—Ç–µ—Ä—å–µ—Ä
  if (name.includes("—Å—Ç–æ–ª") || name.includes("—Å—Ç—É–ª") || name.includes("–∫—Ä–æ–≤–∞—Ç—å") ||
      name.includes("–¥–∏–≤–∞–Ω") || name.includes("—à–∫–∞—Ñ") || name.includes("–ø–æ–ª–∫–∞") ||
      name.includes("–∫—Ä–µ—Å–ª–æ") || name.includes("–º–µ–±–µ–ª—å")) {
    return "–£—é—Ç–Ω—ã–π –¥–æ–º–∞—à–Ω–∏–π —Å—Ç–∏–ª—å: —Ç–µ–ø–ª—ã–µ —Ç–æ–Ω–∞, –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã (–¥–µ—Ä–µ–≤–æ, —Ç–µ–∫—Å—Ç–∏–ª—å), –º—è–≥–∫–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ, –¥–æ–º–∞—à–Ω—è—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞.";
  }
  
  // –†–∞—Å—Ç–µ–Ω–∏—è –∏ —Å–∞–¥
  if (name.includes("–∫–∞—à–ø–æ") || name.includes("–≥–æ—Ä—à–æ–∫") || name.includes("—Ä–∞—Å—Ç–µ–Ω–∏–µ") ||
      name.includes("—Ü–≤–µ—Ç–æ–∫") || name.includes("—Å–∞–¥") || name.includes("—Ä–∞—Å—Å–∞–¥–∞")) {
    return "–ü—Ä–∏—Ä–æ–¥–Ω—ã–π —Å—Ç–∏–ª—å: —Å–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –ø—Ä–∏—Ä–æ–¥—ã (–ª–∏—Å—Ç—å—è, —Ä–∞—Å—Ç–µ–Ω–∏—è), –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã, —Å–≤–µ–∂–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞.";
  }
  
  // –û–¥–µ–∂–¥–∞ –∏ —Ç–µ–∫—Å—Ç–∏–ª—å
  if (name.includes("—Ñ—É—Ç–±–æ–ª–∫–∞") || name.includes("—Ä—É–±–∞—à–∫–∞") || name.includes("–ø–ª–∞—Ç—å–µ") ||
      name.includes("–æ–¥–µ–∂–¥–∞") || name.includes("—Ç–∫–∞–Ω—å") || name.includes("—Ç–µ–∫—Å—Ç–∏–ª—å")) {
    return "–°—Ç–∏–ª—å–Ω—ã–π –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Ñ–æ–Ω: –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ —Ç–æ–Ω–∞, —ç–ª–µ–≥–∞–Ω—Ç–Ω–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è, –∞–∫—Ü–µ–Ω—Ç –Ω–∞ —Ç–æ–≤–∞—Ä–µ.";
  }
  
  // –ö–æ—Å–º–µ—Ç–∏–∫–∞ –∏ –∫—Ä–∞—Å–æ—Ç–∞
  if (name.includes("–∫—Ä–µ–º") || name.includes("—à–∞–º–ø—É–Ω—å") || name.includes("–∫–æ—Å–º–µ—Ç–∏–∫–∞") ||
      name.includes("–º–∞–∫–∏—è–∂") || name.includes("–ø–∞—Ä—Ñ—é–º")) {
    return "–ü—Ä–µ–º–∏–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å: —ç–ª–µ–≥–∞–Ω—Ç–Ω—ã–π —Ñ–æ–Ω, –º—è–≥–∫–∏–µ –ø–∞—Å—Ç–µ–ª—å–Ω—ã–µ —Ç–æ–Ω–∞ –∏–ª–∏ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–µ —Ü–≤–µ—Ç–∞, –ª—é–∫—Å–æ–≤—ã–π –≤–∏–¥.";
  }
  
  // –°–ø–æ—Ä—Ç –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
  if (name.includes("–∫—Ä–æ—Å—Å–æ–≤–∫–∏") || name.includes("—Å–ø–æ—Ä—Ç") || name.includes("—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞") ||
      name.includes("—Ñ–∏—Ç–Ω–µ—Å") || name.includes("–º—è—á")) {
    return "–î–∏–Ω–∞–º–∏—á–Ω—ã–π —Å—Ç–∏–ª—å: —è—Ä–∫–∏–µ —Ü–≤–µ—Ç–∞, —ç–Ω–µ—Ä–≥–∏—á–Ω–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–π –≤–∏–¥.";
  }
  
  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å
  return "–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å: —Å—Ç–∏–ª—å–Ω—ã–π —Ñ–æ–Ω, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ø–æ–ª–Ω—è–µ—Ç —Ç–æ–≤–∞—Ä, –ø—Ä–∏—è—Ç–Ω–∞—è —Ü–≤–µ—Ç–æ–≤–∞—è –≥–∞–º–º–∞, –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ.";
}

/**
 * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–π –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –¥–ª—è –≤–∞—Ä–∏–∞—Ü–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏
 * 
 * –ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢:
 * 1. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–æ–º–µ—Ä –≤–∞—Ä–∏–∞—Ü–∏–∏ (0, 1, 2, 3) - —ç—Ç–æ –∏–Ω–¥–µ–∫—Å –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —Å–µ—Ç–∫–µ
 * 2. –ï—Å—Ç—å 4 –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏:
 *    - 0: –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è (—Ç–æ–≤–∞—Ä –ø–æ —Ü–µ–Ω—Ç—Ä—É, —Ç–µ–∫—Å—Ç —Å–≤–µ—Ä—Ö—É)
 *    - 1: –ê—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞—è (—Ç–æ–≤–∞—Ä –≤ —Å—Ç–æ—Ä–æ–Ω–µ, —Ç–µ–∫—Å—Ç —Å –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã)
 *    - 2: –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è (–º–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞, —á–∏—Å—Ç—ã–π –¥–∏–∑–∞–π–Ω)
 *    - 3: –Ø—Ä–∫–∞—è (—Å–º–µ–ª–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ, –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–µ —Ü–≤–µ—Ç–∞)
 * 3. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä % (–æ—Å—Ç–∞—Ç–æ–∫ –æ—Ç –¥–µ–ª–µ–Ω–∏—è) –¥–ª—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–±–æ—Ä–∞:
 *    - variationIndex % 4 –≤—Å–µ–≥–¥–∞ –¥–∞—Å—Ç 0, 1, 2 –∏–ª–∏ 3
 *    - –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –¥–∞–∂–µ –µ—Å–ª–∏ –≤–∞—Ä–∏–∞—Ü–∏–π –±–æ–ª—å—à–µ 4, –æ–Ω–∏ –±—É–¥—É—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏ –ø–æ–≤—Ç–æ—Ä—è—Ç—å—Å—è
 * 4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
 * 
 * –ü–†–ò–ú–ï–†:
 * - –í—Ö–æ–¥: variationIndex = 0 (–ø–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞)
 * - –í—ã–±–∏—Ä–∞–µ—Ç: concepts[0] = "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è"
 * - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è: –¢–æ–≤–∞—Ä –ø–æ —Ü–µ–Ω—Ç—Ä—É, —Ç–µ–∫—Å—Ç —Å–≤–µ—Ä—Ö—É..."
 * 
 * - –í—Ö–æ–¥: variationIndex = 1 (–≤—Ç–æ—Ä–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞)
 * - –í—ã–±–∏—Ä–∞–µ—Ç: concepts[1] = "–ê—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è"
 * - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: "–ê—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è: –¢–æ–≤–∞—Ä —Å–º–µ—â–µ–Ω –≤ —Å—Ç–æ—Ä–æ–Ω—É..."
 * 
 * –¶–ï–õ–¨: –ü—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ 4 –∫–∞—Ä—Ç–æ—á–µ–∫ –∫–∞–∂–¥–∞—è –ø–æ–ª—É—á–∏—Ç —Å–≤–æ—é —É–Ω–∏–∫–∞–ª—å–Ω—É—é –∫–æ–Ω—Ü–µ–ø—Ü–∏—é –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏,
 * —á—Ç–æ —Å–¥–µ–ª–∞–µ—Ç –∏—Ö –≤–∏–∑—É–∞–ª—å–Ω–æ —Ä–∞–∑–Ω—ã–º–∏, –Ω–æ —Å –æ–¥–Ω–∏–º —Ç–æ–≤–∞—Ä–æ–º –∏ —Ç–µ–∫—Å—Ç–æ–º.
 */
function getVariationConcept(variationIndex: number, productName: string): string {
  const concepts = [
    {
      name: "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è",
      description: "–¢–æ–≤–∞—Ä –ø–æ —Ü–µ–Ω—Ç—Ä—É, —Ç–µ–∫—Å—Ç —Å–≤–µ—Ä—Ö—É, —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–∞—è –∫–æ–º–ø–æ–Ω–æ–≤–∫–∞"
    },
    {
      name: "–ê—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è",
      description: "–¢–æ–≤–∞—Ä —Å–º–µ—â–µ–Ω –≤ —Å—Ç–æ—Ä–æ–Ω—É, —Ç–µ–∫—Å—Ç —Ä–∞–∑–º–µ—â–µ–Ω —Å –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã, –¥–∏–Ω–∞–º–∏—á–Ω–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è"
    },
    {
      name: "–ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è",
      description: "–ú–Ω–æ–≥–æ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞, —Ç–æ–≤–∞—Ä –∏ —Ç–µ–∫—Å—Ç –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω—ã, —á–∏—Å—Ç—ã–π –¥–∏–∑–∞–π–Ω"
    },
    {
      name: "–Ø—Ä–∫–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è",
      description: "–°–º–µ–ª–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–µ —Ü–≤–µ—Ç–∞, –∑–∞–ø–æ–º–∏–Ω–∞—é—â–∏–π—Å—è –¥–∏–∑–∞–π–Ω"
    }
  ];
  
  // variationIndex % 4 –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∏–Ω–¥–µ–∫—Å –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç 0, 1, 2 –∏–ª–∏ 3
  const concept = concepts[variationIndex % concepts.length];
  return `${concept.name}: ${concept.description}.`;
}

/**
 * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞ —á–µ—Ä–µ–∑ Nanobanana Pro
 */
export async function POST(request: NextRequest) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ API –∫–ª—é—á–∞
  if (!process.env.KIE_AI_API_KEY && !process.env.KIE_API_KEY) {
    return NextResponse.json({
      success: false,
      error: "KIE_AI_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω",
      details: "–î–æ–±–∞–≤—å—Ç–µ KIE_AI_API_KEY (–∏–ª–∏ KIE_API_KEY) –≤ —Ñ–∞–π–ª .env.local",
    }, { status: 500 });
  }

  try {
    const body = await request.json();
    
    const {
      productName,
      photoUrl,
      customPrompt, // –ü–æ–∂–µ–ª–∞–Ω–∏—è –∫ —Å—Ç–∏–ª—é
      addText, // –í–∫–ª—é—á–µ–Ω –ª–∏ —Ç–µ–∫—Å—Ç –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ
      title, // –ó–∞–≥–æ–ª–æ–≤–æ–∫
      bullets, // –ë—É–ª–ª–∏—Ç—ã (–º–∞—Å—Å–∏–≤)
      aspectRatio, // "3:4" –∏–ª–∏ "1:1"
      variation = 0, // –ù–æ–º–µ—Ä –≤–∞—Ä–∏–∞—Ü–∏–∏ (0-3) –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–æ–Ω—Ü–µ–ø—Ü–∏–π
      designConcept, // –ì–æ—Ç–æ–≤–∞—è –¥–∏–∑–∞–π–Ω-–∫–æ–Ω—Ü–µ–ø—Ü–∏—è (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–∞)
    } = body;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
    if (!productName) {
      return NextResponse.json(
        { success: false, error: "–¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" },
        { status: 400 }
      );
    }

    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è API
    let imageForApi: string | undefined;
    
    if (photoUrl) {
      // –ï—Å–ª–∏ —ç—Ç–æ base64, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –µ—Å—Ç—å (–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä)
      if (photoUrl.startsWith("data:")) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä base64 (–ø—Ä–∏–º–µ—Ä–Ω–æ 4/3 –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞)
        const base64Size = photoUrl.length;
        const maxSize = 10 * 1024 * 1024; // 10MB
        
        if (base64Size > maxSize) {
          console.warn("‚ö†Ô∏è Base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –Ω–µ–≥–æ");
          imageForApi = undefined;
        } else {
          imageForApi = photoUrl;
          console.log("üì∑ –ò—Å–ø–æ–ª—å–∑—É–µ–º base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, —Ä–∞–∑–º–µ—Ä:", Math.round(base64Size / 1024), "KB");
        }
      } else if (photoUrl.startsWith("http://") || photoUrl.startsWith("https://")) {
        // localhost ‚Äî —á–∏—Ç–∞–µ–º —Å –¥–∏—Å–∫–∞ –∏ –æ—Ç–¥–∞—ë–º data URL (KIE –Ω–µ –¥–µ—Ä–≥–∞–µ—Ç localhost)
        try {
          const u = new URL(photoUrl);
          if (u.hostname === "localhost" || u.hostname === "127.0.0.1") {
            const localPath = path.join(process.cwd(), "public", u.pathname);
            await fs.access(localPath);
            const buffer = await fs.readFile(localPath);
            if (buffer.length <= 10 * 1024 * 1024) {
              let mimeType = "image/jpeg";
              const header = buffer.slice(0, 4);
              if (header[0] === 0x89 && header[1] === 0x50 && header[2] === 0x4E && header[3] === 0x47) mimeType = "image/png";
              else if (header[0] === 0xFF && header[1] === 0xD8 && header[2] === 0xFF) mimeType = "image/jpeg";
              else {
                const ext = path.extname(u.pathname).toLowerCase();
                if (ext === ".png") mimeType = "image/png";
                else if (ext === ".webp") mimeType = "image/webp";
              }
              imageForApi = `data:${mimeType};base64,${buffer.toString("base64")}`;
              console.log("üì∑ –õ–æ–∫–∞–ª—å–Ω—ã–π URL –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω –≤ data URL –¥–ª—è KIE");
            } else {
              imageForApi = photoUrl;
              console.log("üì∑ –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π URL (—Ñ–∞–π–ª –±–æ–ª—å—à–æ–π)");
            }
          } else {
            imageForApi = photoUrl;
            console.log("üì∑ –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π URL");
          }
        } catch {
          imageForApi = photoUrl;
          console.log("üì∑ –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π URL");
        }
      } else {
        // –ï—Å–ª–∏ —ç—Ç–æ –ª–æ–∫–∞–ª—å–Ω—ã–π URL, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64
        try {
          const localPath = photoUrl.startsWith("/") 
            ? path.join(process.cwd(), "public", photoUrl)
            : photoUrl;
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
          await fs.access(localPath);
          
          // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
          const buffer = await fs.readFile(localPath);
          const fileSize = buffer.length;
          
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å 10MB –¥–ª—è base64)
          if (fileSize > 10 * 1024 * 1024) {
            console.warn("‚ö†Ô∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –Ω–µ–≥–æ");
            imageForApi = undefined;
          } else {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME-—Ç–∏–ø –ø–æ —Å–∏–≥–Ω–∞—Ç—É—Ä–µ —Ñ–∞–π–ª–∞ (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ, —á–µ–º –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é)
            let mimeType = "image/jpeg"; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const header = buffer.slice(0, 4);
            
            // PNG: 89 50 4E 47
            if (header[0] === 0x89 && header[1] === 0x50 && header[2] === 0x4E && header[3] === 0x47) {
              mimeType = "image/png";
            }
            // JPEG: FF D8 FF
            else if (header[0] === 0xFF && header[1] === 0xD8 && header[2] === 0xFF) {
              mimeType = "image/jpeg";
            }
            // –ï—Å–ª–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏, –ø—Ä–æ–±—É–µ–º –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é
            else {
              const ext = path.extname(photoUrl).toLowerCase();
              if (ext === ".png") mimeType = "image/png";
              else if (ext === ".jpg" || ext === ".jpeg") mimeType = "image/jpeg";
              else if (ext === ".webp") mimeType = "image/webp";
            }
            
            const base64 = buffer.toString("base64");
            imageForApi = `data:${mimeType};base64,${base64}`;
            console.log("üì∑ –õ–æ–∫–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ base64:");
            console.log("   - –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:", Math.round(fileSize / 1024), "KB");
            console.log("   - MIME-—Ç–∏–ø:", mimeType);
            console.log("   - –†–∞–∑–º–µ—Ä base64:", Math.round(imageForApi.length / 1024), "KB");
          }
        } catch (error) {
          console.warn("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –Ω–µ–≥–æ:", error);
          imageForApi = undefined;
        }
      }
    }

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—É—é –∫–æ–Ω—Ü–µ–ø—Ü–∏—é –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ä—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
    let finalStyle: string;
    let finalComposition: string;
    let finalColors: string;
    let finalMood: string;
    let finalTextPresentation: string | undefined;

    if (designConcept) {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—É—é –∫–æ–Ω—Ü–µ–ø—Ü–∏—é –æ—Ç OpenRouter
      finalStyle = designConcept.style;
      finalComposition = designConcept.composition;
      finalColors = designConcept.colors;
      finalMood = designConcept.mood;
      finalTextPresentation = designConcept.textPresentation;
    } else {
      // Fallback –Ω–∞ —Å—Ç–∞—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
      const smartStyle = getSmartStyleForProduct(productName);
      const variationConcept = getVariationConcept(variation, productName);
      finalStyle = smartStyle;
      finalComposition = variationConcept;
      finalColors = "–ü–æ–¥—Ö–æ–¥—è—â–∞—è —Ü–≤–µ—Ç–æ–≤–∞—è –≥–∞–º–º–∞ –¥–ª—è —Ç–æ–≤–∞—Ä–∞";
      finalMood = "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π";
      finalTextPresentation = undefined;
    }
    
    // –°—Ç—Ä–æ–∏–º –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞
    let finalPrompt = `–°–æ–∑–¥–∞–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é –ö–ê–†–¢–û–ß–ö–£ –¢–û–í–ê–†–ê –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ (Ozon, Wildberries, –Ø–Ω–¥–µ–∫—Å –ú–∞—Ä–∫–µ—Ç).

–í–ê–ñ–ù–û: –≠—Ç–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∏–º–µ–Ω–Ω–æ –ö–ê–†–¢–û–ß–ö–ê —Å –ø—Ä–æ–¥—É–º–∞–Ω–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º, –∞ –ù–ï –ø—Ä–æ—Å—Ç–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Ñ–æ–Ω–µ.

=== –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê –ü–ï–†–ï–î –ì–ï–ù–ï–†–ê–¶–ò–ï–ô ===
–ü–ï–†–ï–î –¢–ï–ú –ö–ê–ö –ù–ê–ß–ê–¢–¨ –ì–ï–ù–ï–†–ê–¶–ò–Æ, –í–´–ü–û–õ–ù–ò –°–õ–ï–î–£–Æ–©–£–Æ –ü–†–û–í–ï–†–ö–£:

1. –ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
2. –ü—Ä–æ—á–∏—Ç–∞–π –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞: "${productName}"
3. –û–ü–†–ï–î–ï–õ–ò, —á—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–æ –Ω–∞ —Ñ–æ—Ç–æ (–∫–∞–∫–æ–π –∏–º–µ–Ω–Ω–æ —Ç–æ–≤–∞—Ä)
4. –°–†–ê–í–ù–ò —Ç–æ–≤–∞—Ä –Ω–∞ —Ñ–æ—Ç–æ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º "${productName}"

–ï–°–õ–ò –¢–û–í–ê–† –ù–ê –§–û–¢–û –ù–ï –°–û–û–¢–í–ï–¢–°–¢–í–£–ï–¢ –ù–ê–ó–í–ê–ù–ò–Æ "${productName}" - –ù–ï–ú–ï–î–õ–ï–ù–ù–û –û–°–¢–ê–ù–û–í–ò–°–¨ –ò –ù–ï –ì–ï–ù–ï–†–ò–†–£–ô –ö–ê–†–¢–û–ß–ö–£!
–≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ - –Ω–µ–ª—å–∑—è –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞!

–ï–°–õ–ò –¢–û–í–ê–† –ù–ê –§–û–¢–û –°–û–û–¢–í–ï–¢–°–¢–í–£–ï–¢ –ù–ê–ó–í–ê–ù–ò–Æ "${productName}" - –ø—Ä–æ–¥–æ–ª–∂–∞–π –≥–µ–Ω–µ—Ä–∞—Ü–∏—é.

=== –¢–û–í–ê–† ===
${productName}

=== –†–ï–§–ï–†–ï–ù–°–ù–û–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ï ===
–°–¢–†–û–ì–û –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∫–∞–∫ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å.
- –¢–æ–≤–∞—Ä –¥–æ–ª–∂–µ–Ω –≤—ã–≥–ª—è–¥–µ—Ç—å –¢–û–ß–ù–û –¢–ê–ö –ñ–ï, –∫–∞–∫ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ - –ù–ï –∏—Å–∫–∞–∂–∞–π –µ–≥–æ —Ñ–æ—Ä–º—É, —Ä–∞–∑–º–µ—Ä, –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏, –û–†–ò–ï–ù–¢–ê–¶–ò–Æ, –†–ê–ö–£–†–°
- –¢–æ–≤–∞—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –¢–û–ú –ñ–ï –ø–æ–ª–æ–∂–µ–Ω–∏–∏ –∏ —Å –¢–û–ì–û –ñ–ï —Ä–∞–∫—É—Ä—Å–∞, —á—Ç–æ –∏ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏:
  * –ï—Å–ª–∏ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä –ø–æ–∫–∞–∑–∞–Ω —Å–±–æ–∫—É - –ø–æ–∫–∞–∂–∏ –µ–≥–æ —Å–±–æ–∫—É, –ù–ï —Å–≤–µ—Ä—Ö—É –∏ –ù–ï —Å–∑–∞–¥–∏!
  * –ï—Å–ª–∏ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä –ø–æ–∫–∞–∑–∞–Ω —Å–ø–µ—Ä–µ–¥–∏ - –ø–æ–∫–∞–∂–∏ –µ–≥–æ —Å–ø–µ—Ä–µ–¥–∏, –ù–ï —Å–±–æ–∫—É –∏ –ù–ï —Å–≤–µ—Ä—Ö—É!
  * –ï—Å–ª–∏ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä –ø–æ–∫–∞–∑–∞–Ω —Å–≤–µ—Ä—Ö—É - –ø–æ–∫–∞–∂–∏ –µ–≥–æ —Å–≤–µ—Ä—Ö—É, –ù–ï —Å–±–æ–∫—É –∏ –ù–ï —Å–∑–∞–¥–∏!
  * –ù–ï –º–µ–Ω—è–π —Ä–∞–∫—É—Ä—Å —Å—ä–µ–º–∫–∏ - –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–¢ –ñ–ï —Ä–∞–∫—É—Ä—Å, —á—Ç–æ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏!
- –ù–ï –¥–µ–ª–∞–π —Ç–æ–≤–∞—Ä –º—É–ª—å—Ç—è—à–Ω—ã–º, –Ω–µ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º –∏–ª–∏ —Ñ–∞–Ω—Ç–∞—Å—Ç–∏—á–µ—Å–∫–∏–º - –æ–Ω –¥–æ–ª–∂–µ–Ω –≤—ã–≥–ª—è–¥–µ—Ç—å –†–ï–ê–õ–¨–ù–û
- –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–æ–ª–∂–Ω–∞ –≤—ã–≥–ª—è–¥–µ—Ç—å –∫–∞–∫ –°–ù–Ø–¢–ê–Ø –ù–ê –ö–ê–ú–ï–†–£, –∞ –ù–ï —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é! –î–æ–±–∞–≤—å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –¥–µ—Ç–∞–ª–∏: –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ, —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ —Ç–µ–Ω–∏, —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –æ—Ç—Ä–∞–∂–µ–Ω–∏—è, —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ —Ç–µ–∫—Å—Ç—É—Ä—ã, –Ω–µ–±–æ–ª—å—à–∏–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–µ—Ñ–µ–∫—Ç—ã (–ø—ã–ª—å, —Ü–∞—Ä–∞–ø–∏–Ω—ã, –æ—Ç–ø–µ—á–∞—Ç–∫–∏ –ø–∞–ª—å—Ü–µ–≤), —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—É—é –≥–ª—É–±–∏–Ω—É —Ä–µ–∑–∫–æ—Å—Ç–∏. –ò–∑–±–µ–≥–∞–π "–∏–¥–µ–∞–ª—å–Ω–æ—Å—Ç–∏" - —Å–¥–µ–ª–∞–π —Ç–∞–∫, —á—Ç–æ–±—ã –≤—ã–≥–ª—è–¥–µ–ª–æ –∫–∞–∫ —Ä–µ–∞–ª—å–Ω–∞—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è!
- –£–ª—É—á—à–∏ –∫–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: —Å–¥–µ–ª–∞–π –µ–≥–æ –±–æ–ª–µ–µ —á–µ—Ç–∫–∏–º, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º, —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å—Ç—É–¥–∏–π–Ω—ã–º –æ—Å–≤–µ—â–µ–Ω–∏–µ–º
- –£–ª—É—á—à–∏ –≤–∏–∑—É–∞–ª—å–Ω–æ (–æ—Å–≤–µ—â–µ–Ω–∏–µ, —Ü–≤–µ—Ç–∞, –¥–µ—Ç–∞–ª–∏), –Ω–æ –°–û–•–†–ê–ù–ò —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –≤–∏–¥ —Ç–æ–≤–∞—Ä–∞, –µ–≥–æ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é –∏ —Ä–∞–∫—É—Ä—Å
- –¢–æ–≤–∞—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∑–Ω–∞–≤–∞–µ–º—ã–º –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∏—Å—Ö–æ–¥–Ω–æ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é –∏ –Ω–∞–∑–≤–∞–Ω–∏—é "${productName}"

=== –ö–û–ù–¶–ï–ü–¶–ò–Ø –ö–û–ú–ü–û–ó–ò–¶–ò–ò ===
${finalComposition}

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –ü–†–ò –†–ï–ê–õ–ò–ó–ê–¶–ò–ò –ö–û–ù–¶–ï–ü–¶–ò–ò:
- –ü–†–û–ê–ù–ê–õ–ò–ó–ò–†–£–ô —Ç–æ–≤–∞—Ä "${productName}" –∏ –æ–ø—Ä–µ–¥–µ–ª–∏, –≥–¥–µ –æ–Ω –†–ï–ê–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∂–∏–∑–Ω–∏
- –†–∞–∑–º–µ—Å—Ç–∏ —Ç–æ–≤–∞—Ä –õ–û–ì–ò–ß–ù–û –∏ –ü–†–ê–í–ò–õ–¨–ù–û:
  * –ì–ª–∞–¥–∏–ª—å–Ω–∞—è –¥–æ—Å–∫–∞ - –Ω–∞ –ø–æ–ª—É –∏–ª–∏ –Ω–∞ –ø–æ–¥—Å—Ç–∞–≤–∫–µ, –ù–ï –Ω–∞ —Å—Ç–æ–ª–µ!
  * –í–µ–¥—Ä–æ - –Ω–∞ –ø–æ–ª—É –∏–ª–∏ –Ω–∞ –ø–æ–ª–∫–µ, –ù–ï –Ω–∞ –æ–±–µ–¥–µ–Ω–Ω–æ–º —Å—Ç–æ–ª–µ!
  * –ö–∞—à–ø–æ - –Ω–∞ –ø–æ–¥–æ–∫–æ–Ω–Ω–∏–∫–µ, –ø–æ–ª–∫–µ –∏–ª–∏ —Å—Ç–æ–ª–µ (—ç—Ç–æ –ª–æ–≥–∏—á–Ω–æ), –ù–ï –Ω–∞ –ø–æ–ª—É –≤ –≥–æ—Å—Ç–∏–Ω–æ–π!
  * –°—Ç–æ–ª - –Ω–∞ –ø–æ–ª—É –∏–ª–∏ –Ω–∞ –∫–æ–≤—Ä–µ, –ù–ï –Ω–∞ –¥—Ä—É–≥–æ–º —Å—Ç–æ–ª–µ!
  * –î—É–º–∞–π –ª–æ–≥–∏—á–Ω–æ: –≥–¥–µ –†–ï–ê–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?
- –ï—Å–ª–∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏—è –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –Ω–µ–ª–æ–≥–∏—á–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≥–ª–∞–¥–∏–ª—å–Ω–∞—è –¥–æ—Å–∫–∞ –Ω–∞ —Å—Ç–æ–ª–µ) - –ò–ì–ù–û–†–ò–†–£–ô —ç—Ç–æ –∏ —Ä–∞–∑–º–µ—Å—Ç–∏ —Ç–æ–≤–∞—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ!
- –¢–æ–≤–∞—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –¢–û–ú –ñ–ï –ø–æ–ª–æ–∂–µ–Ω–∏–∏ –∏ —Å –¢–û–ì–û –ñ–ï —Ä–∞–∫—É—Ä—Å–∞, —á—Ç–æ –∏ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ - –ù–ï –º–µ–Ω—è–π –µ–≥–æ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é, –ù–ï –º–µ–Ω—è–π —Ä–∞–∫—É—Ä—Å —Å—ä–µ–º–∫–∏!
- –ï—Å–ª–∏ –≤ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –Ω–∞–∫–ª–æ–Ω —Ç–æ–≤–∞—Ä–∞, –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è, —É–≥–ª–∞ –∏–ª–∏ —Ä–∞–∫—É—Ä—Å–∞ - –ò–ì–ù–û–†–ò–†–£–ô —ç—Ç–æ!
- –¢–æ–≤–∞—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –ù–û–†–ú–ê–õ–¨–ù–û–ú, –ï–°–¢–ï–°–¢–í–ï–ù–ù–û–ú –ø–æ–ª–æ–∂–µ–Ω–∏–∏ –∏ —Å –¢–û–ì–û –ñ–ï —Ä–∞–∫—É—Ä—Å–∞, –∫–∞–∫ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
- –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω—Ü–µ–ø—Ü–∏—é –¢–û–õ–¨–ö–û –¥–ª—è —Ñ–æ–Ω–∞, —Å—Ç–∏–ª—è, —Ü–≤–µ—Ç–æ–≤, —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ - –ù–ï –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª–æ–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ —Ä–∞–∫—É—Ä—Å–∞!
- –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–π —Ç–æ–≤–∞—Ä —Å–≤–µ—Ä—Ö—É, –µ—Å–ª–∏ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –æ–Ω –ø–æ–∫–∞–∑–∞–Ω —Å–±–æ–∫—É! –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–π —Ç–æ–≤–∞—Ä —Å–∑–∞–¥–∏, –µ—Å–ª–∏ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –æ–Ω –ø–æ–∫–∞–∑–∞–Ω —Å–ø–µ—Ä–µ–¥–∏! –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–¢ –ñ–ï —Ä–∞–∫—É—Ä—Å!

–í–ê–ñ–ù–û: –°–ª–µ–¥—É–π –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –¥–ª—è —Ñ–æ–Ω–∞ –∏ —Å—Ç–∏–ª—è, –Ω–æ —Ç–æ–≤–∞—Ä –¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –≤ —Ç–æ–º –∂–µ –ø–æ–ª–æ–∂–µ–Ω–∏–∏, —á—Ç–æ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏, –∏ –±—ã—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω –õ–û–ì–ò–ß–ù–û!

=== –°–¢–ò–õ–¨ –ò –§–û–ù ===`;

    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª—å (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ)
    if (customPrompt && customPrompt.trim()) {
      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∫–∞–∑–∞–ª –ø–æ–∂–µ–ª–∞–Ω–∏—è, –∫–æ–º–±–∏–Ω–∏—Ä—É–µ–º –∏—Ö —Å –∫–æ–Ω—Ü–µ–ø—Ü–∏–µ–π
      finalPrompt += `
${customPrompt}

–î–ï–¢–ê–õ–¨–ù–ê–Ø –ö–û–ù–¶–ï–ü–¶–ò–Ø –î–ò–ó–ê–ô–ù–ê (—Å–æ–∑–¥–∞–Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º –¥–∏–∑–∞–π–Ω–µ—Ä–æ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞):
${finalStyle}

–ö–û–ù–ö–†–ï–¢–ù–ê–Ø –¶–í–ï–¢–û–í–ê–Ø –ü–ê–õ–ò–¢–†–ê:
${finalColors}

–ê–¢–ú–û–°–§–ï–†–ê –ò –ù–ê–°–¢–†–û–ï–ù–ò–ï:
${finalMood}

–í–ê–ñ–ù–û: –¢–æ—á–Ω–æ —Ä–µ–∞–ª–∏–∑—É–π —ç—Ç—É –∫–æ–Ω—Ü–µ–ø—Ü–∏—é. –≠—Ç–æ –Ω–µ –æ–±—â–∏–µ —Å–ª–æ–≤–∞ - —ç—Ç–æ –¥–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏, –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏, —Ç–µ–∫—Å—Ç—É—Ä–∞–º–∏ –∏ –æ—Å–≤–µ—â–µ–Ω–∏–µ–º. –°–æ–∑–¥–∞–π –∫–∞—Ä—Ç–æ—á–∫—É —É—Ä–æ–≤–Ω—è –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã—Ö —Ñ–æ—Ç–æ—Å—Ç—É–¥–∏–π –∏ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∞–≥–µ–Ω—Ç—Å—Ç–≤.`;
    } else {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ü–µ–ø—Ü–∏—é
      finalPrompt += `
–î–ï–¢–ê–õ–¨–ù–ê–Ø –ö–û–ù–¶–ï–ü–¶–ò–Ø –î–ò–ó–ê–ô–ù–ê (—Å–æ–∑–¥–∞–Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º –¥–∏–∑–∞–π–Ω–µ—Ä–æ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞):
${finalStyle}

–ö–û–ù–ö–†–ï–¢–ù–ê–Ø –¶–í–ï–¢–û–í–ê–Ø –ü–ê–õ–ò–¢–†–ê:
${finalColors}

–ê–¢–ú–û–°–§–ï–†–ê –ò –ù–ê–°–¢–†–û–ï–ù–ò–ï:
${finalMood}

–í–ê–ñ–ù–û: –¢–æ—á–Ω–æ —Ä–µ–∞–ª–∏–∑—É–π —ç—Ç—É –∫–æ–Ω—Ü–µ–ø—Ü–∏—é. –≠—Ç–æ –Ω–µ –æ–±—â–∏–µ —Å–ª–æ–≤–∞ - —ç—Ç–æ –¥–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏, –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º–∏, —Ç–µ–∫—Å—Ç—É—Ä–∞–º–∏ –∏ –æ—Å–≤–µ—â–µ–Ω–∏–µ–º. –°–æ–∑–¥–∞–π –∫–∞—Ä—Ç–æ—á–∫—É —É—Ä–æ–≤–Ω—è –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã—Ö —Ñ–æ—Ç–æ—Å—Ç—É–¥–∏–π –∏ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∞–≥–µ–Ω—Ç—Å—Ç–≤. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç–æ–π –æ–¥–Ω–æ—Ç–æ–Ω–Ω—ã–π —Ñ–æ–Ω.`;
    }

    // –¢–µ–∫—Å—Ç –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ - –ö–†–ï–ê–¢–ò–í–ù–´–ô –ü–û–î–•–û–î
    if (addText) {
      const titleText = (title && title.trim()) ? title.trim() : productName;
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—Ä–µ–∞—Ç–∏–≤–Ω—É—é –∫–æ–Ω—Ü–µ–ø—Ü–∏—é –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞, –µ—Å–ª–∏ –µ—Å—Ç—å
      const textPresentationInstruction = finalTextPresentation 
        ? `\n\n–ö–†–ï–ê–¢–ò–í–ù–ê–Ø –ö–û–ù–¶–ï–ü–¶–ò–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –¢–ï–ö–°–¢–ê (–æ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–µ—Ä–∞):
${finalTextPresentation}

–í–ê–ñ–ù–û: –†–µ–∞–ª–∏–∑—É–π –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞. –≠—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ - —ç—Ç–æ –≤–∏–∑—É–∞–ª—å–Ω–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç!`
        : `\n\n–†–ê–ó–ú–ï–©–ï–ù–ò–ï –¢–ï–ö–°–¢–ê: –ü—Ä–æ—è–≤–∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å! –¢—ã –º–æ–∂–µ—à—å —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å —Ç–µ–∫—Å—Ç –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ –∏ –≤ –ª—é–±–æ–º —Ñ–æ—Ä–º–∞—Ç–µ, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –¥–∞–Ω–Ω–æ–π –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏. –ú–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–µ–π–¥–∂–∏, –ø–ª–∞—à–∫–∏, –Ω–µ–æ–±—ã—á–Ω—ã–µ —Ñ–æ—Ä–º—ã, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –≤ –∫–æ–º–ø–æ–∑–∏—Ü–∏—é - –≥–ª–∞–≤–Ω–æ–µ, —á—Ç–æ–±—ã —ç—Ç–æ –±—ã–ª–æ –í–ò–ó–£–ê–õ–¨–ù–û –ò–ù–¢–ï–†–ï–°–ù–û –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª–æ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏.`;

      finalPrompt += `\n\n=== –¢–ï–ö–°–¢ –ù–ê –ö–ê–†–¢–û–ß–ö–ï - –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ô –†–ê–ó–î–ï–õ ===

üö´ –ê–ë–°–û–õ–Æ–¢–ù–´–ô –ó–ê–ü–†–ï–¢ - –ù–ò –ü–†–ò –ö–ê–ö–ò–• –£–°–õ–û–í–ò–Ø–• –ù–ï –î–ï–õ–ê–ô –°–õ–ï–î–£–Æ–©–ï–ï:
- –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Å–≤–æ–π —Ç–µ–∫—Å—Ç - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞–¥–ø–∏—Å–∏ - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ù–ï –ø–∏—à–∏ –Ω–∏—á–µ–≥–æ, –∫—Ä–æ–º–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –Ω–∏–∂–µ —Ç–µ–∫—Å—Ç–∞ - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –±—ã–ª —É–∫–∞–∑–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ù–ï —Å–æ–∑–¥–∞–≤–∞–π —Å–≤–æ–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–∑–≤–∞–Ω–∏–π –∏–ª–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤ - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –æ–ø–∏—Å–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ä–∞–∑–º–µ—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–†–∞–∑–º–µ—Ä–∞: 14,8 —Å–º" –∏–ª–∏ "–†–∞–∑–º–µ—Ä—ã: 125-1970") - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –ª–æ–≥–æ—Ç–∏–ø—ã –∏–ª–∏ –±—Ä–µ–Ω–¥—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "NIKA") - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ç–µ–∫—Å—Ç –ø–æ–¥ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞–º–∏ - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ç–µ–∫—Å—Ç –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ç–µ–∫—Å—Ç –≤ –ª—é–±–æ–º –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ù–ï –ø–∏—à–∏ –Ω–∏—á–µ–≥–æ –æ—Ç —Å–µ–±—è - –ù–ò –û–î–ù–û–ì–û –°–õ–û–í–ê - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–ª —Ç–µ–∫—Å—Ç - –ù–ï –¥–æ–±–∞–≤–ª—è–π –µ–≥–æ —Å–∞–º - –ó–ê–ü–†–ï–©–ï–ù–û!

‚úÖ –†–ê–ó–†–ï–®–ï–ù–û –¢–û–õ–¨–ö–û:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¢–û–õ–¨–ö–û —Ç–æ—Ç —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π —É–∫–∞–∑–∞–Ω –Ω–∏–∂–µ
- –ù–ò–ß–ï–ì–û –ë–û–õ–¨–®–ï!

–ó–ê–ì–û–õ–û–í–û–ö (–Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π, –∫—Ä—É–ø–Ω—ã–º –∂–∏—Ä–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º):
"${titleText}"

‚ö†Ô∏è –í–ê–ñ–ù–û: –≠—Ç–æ –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –∑–∞–≥–æ–ª–æ–≤–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ. –ù–ï –¥–æ–±–∞–≤–ª—è–π –¥—Ä—É–≥–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏. –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ç–µ–∫—Å—Ç –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º. –ù–ï –¥–æ–±–∞–≤–ª—è–π –æ–ø–∏—Å–∞–Ω–∏—è. –¢–û–õ–¨–ö–û —ç—Ç–æ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ - –ù–ò–ß–ï–ì–û –ë–û–õ–¨–®–ï!${textPresentationInstruction}`;

      if (bullets && bullets.length > 0) {
        const validBullets = bullets.filter((b: string) => b && b.trim());
        if (validBullets.length > 0) {
          finalPrompt += `\n\n–ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê –¢–û–í–ê–†–ê (–Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π):

üö´ –ê–ë–°–û–õ–Æ–¢–ù–´–ô –ó–ê–ü–†–ï–¢ - –ù–ò –ü–†–ò –ö–ê–ö–ò–• –£–°–õ–û–í–ò–Ø–• –ù–ï –î–ï–õ–ê–ô –°–õ–ï–î–£–Æ–©–ï–ï:
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –¥—Ä—É–≥–∏–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Å–≤–æ–π —Ç–µ–∫—Å—Ç - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ù–ï —Å–æ–∑–¥–∞–≤–∞–π —Å–≤–æ–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤ - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ù–ï –¥—É–±–ª–∏—Ä—É–π –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ - –∫–∞–∂–¥–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–∫–∞–∑–∞–Ω–æ –¢–û–õ–¨–ö–û –û–î–ò–ù –†–ê–ó - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –±—ã–ª —É–∫–∞–∑–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ç–µ–∫—Å—Ç –ü–û–î –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞–º–∏ - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –æ–ø–∏—Å–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ø–ª–æ—Ç–Ω–æ—Å—Ç—å —á–µ—Ö–ª–∞ 180 g/m2") - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ø—Ä–æ—á–Ω—ã–π –∫–∞—Ä–∫–∞—Å") - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ä–∞–∑–º–µ—Ä—ã - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –ª–æ–≥–æ—Ç–∏–ø—ã –∏–ª–∏ –±—Ä–µ–Ω–¥—ã - –ó–ê–ü–†–ï–©–ï–ù–û!
- –ù–ï –ø–∏—à–∏ –Ω–∏—á–µ–≥–æ –æ—Ç —Å–µ–±—è - –ù–ò –û–î–ù–û–ì–û –°–õ–û–í–ê - –ó–ê–ü–†–ï–©–ï–ù–û!

‚úÖ –†–ê–ó–†–ï–®–ï–ù–û –¢–û–õ–¨–ö–û:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¢–û–õ–¨–ö–û —ç—Ç–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞, –≤ —Ç–æ—á–Ω–æ—Å—Ç–∏ –∫–∞–∫ —É–∫–∞–∑–∞–Ω–æ –Ω–∏–∂–µ
- –ù–ò–ß–ï–ì–û –ë–û–õ–¨–®–ï!`;
          validBullets.forEach((bullet: string, index: number) => {
            finalPrompt += `\n${index + 1}. "${bullet.trim()}"`;
          });
          
          finalPrompt += `\n\n–†–ê–ó–ú–ï–©–ï–ù–ò–ï –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ü–†–ï–ò–ú–£–©–ï–°–¢–í:
- –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–∞–∂–¥–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ: –µ—Å–ª–∏ –æ–Ω–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ —Å–∞–º–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ (—Ç–æ–ª—â–∏–Ω–∞, –ø—Ä–æ—á–Ω–æ—Å—Ç—å, –º–∞—Ç–µ—Ä–∏–∞–ª, —Ä–∞–∑–º–µ—Ä, —Ñ–æ—Ä–º–∞ –∏ —Ç.–¥.), –∏ —ç—Ç–æ –ª–æ–≥–∏—á–Ω–æ –¥–ª—è –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏, –º–æ–∂–µ—à—å –≤–∏–∑—É–∞–ª—å–Ω–æ —Å–≤—è–∑–∞—Ç—å –µ–≥–æ —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —á–∞—Å—Ç—å—é —Ç–æ–≤–∞—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–Ω–∫–∏–º–∏ –ª–∏–Ω–∏—è–º–∏, —É–∫–∞–∑—ã–≤–∞—é—â–∏–º–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É)
- –ï—Å–ª–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ –Ω–µ —Å–≤—è–∑–∞–Ω–æ —Å —Ñ–∏–∑–∏—á–µ—Å–∫–∏–º–∏ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏ —Ç–æ–≤–∞—Ä–∞, –æ—Ç–æ–±—Ä–∞–∑–∏ –µ–≥–æ –∫–∞–∫ –±–µ–π–¥–∂, –ø–ª–∞—à–∫—É, –∏–∫–æ–Ω–∫—É –∏–ª–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫
- –ú–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ–æ–±—ã—á–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã, —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –∏–ª–∏ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã, –Ω–æ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ –¥–ª—è –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –∏ –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ—Ç –¥–∏–∑–∞–π–Ω
- ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ö–∞–∂–¥–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–∫–∞–∑–∞–Ω–æ –¢–û–õ–¨–ö–û –û–î–ò–ù –†–ê–ó - –ù–ï –¥—É–±–ª–∏—Ä—É–π —Ç–µ–∫—Å—Ç!
- ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ç–µ–∫—Å—Ç –ü–û–î –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞–º–∏! –ù–ï –¥–æ–±–∞–≤–ª—è–π –æ–ø–∏—Å–∞–Ω–∏—è, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, —Ä–∞–∑–º–µ—Ä—ã, –ª–æ–≥–æ—Ç–∏–ø—ã! –¢–û–õ–¨–ö–û —É–∫–∞–∑–∞–Ω–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ - –ù–ò–ß–ï–ì–û –ë–û–õ–¨–®–ï!`;
          
          if (finalTextPresentation) {
            finalPrompt += `\n\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –û—Ç–æ–±—Ä–∞–∑–∏ —ç—Ç–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏—Å–ø–æ–ª—å–∑—É—è –∫—Ä–µ–∞—Ç–∏–≤–Ω—É—é –∫–æ–Ω—Ü–µ–ø—Ü–∏—é –≤—ã—à–µ. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å: –±–µ–π–¥–∂–∏ —Å –∏–∫–æ–Ω–∫–∞–º–∏, –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–µ –ø–ª–∞—à–∫–∏, —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –±–ª–æ–∫–∏ —Å –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏, –Ω–µ–æ–±—ã—á–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –∫–æ–º–ø–æ–∑–∏—Ü–∏—é - –ø—Ä–æ—è–≤–∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å! –ù–ï –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ - —Å–¥–µ–ª–∞–π —ç—Ç–æ –í–ò–ó–£–ê–õ–¨–ù–û –ò–ù–¢–ï–†–ï–°–ù–´–ú!`;
          }
          
          finalPrompt += `\n\n‚ö†Ô∏è –§–ò–ù–ê–õ–¨–ù–û–ï –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï:
–≠—Ç–æ –í–°–ï –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ. –ù–ï –¥–æ–±–∞–≤–ª—è–π –¥—Ä—É–≥–∏–µ. –ù–ï –¥—É–±–ª–∏—Ä—É–π —Ç–µ–∫—Å—Ç. –ù–ï –¥–æ–±–∞–≤–ª—è–π –æ–ø–∏—Å–∞–Ω–∏—è, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏, —Ä–∞–∑–º–µ—Ä—ã, –ª–æ–≥–æ—Ç–∏–ø—ã –∏–ª–∏ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π —Ç–µ–∫—Å—Ç. –¢–û–õ–¨–ö–û —É–∫–∞–∑–∞–Ω–Ω—ã–µ –≤—ã—à–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ - –ù–ò–ß–ï–ì–û –ë–û–õ–¨–®–ï!`;
        }
      } else {
        finalPrompt += `\n\n–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è. –†–∞–∑–º–µ—Å—Ç–∏ —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫.`;
      }
    } else {
      finalPrompt += `\n\n=== –¢–ï–ö–°–¢ –ù–ê –ö–ê–†–¢–û–ß–ö–ï ===
üö´ –ê–ë–°–û–õ–Æ–¢–ù–´–ô –ó–ê–ü–†–ï–¢:
–¢–µ–∫—Å—Ç –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è. –°–æ–∑–¥–∞–π –∫–∞—Ä—Ç–æ—á–∫—É —Ç–æ–ª—å–∫–æ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Ç–æ–≤–∞—Ä–∞.
–ù–ï –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ - –ù–ò –ó–ê–ì–û–õ–û–í–ö–û–í, –ù–ò –û–ü–ò–°–ê–ù–ò–ô, –ù–ò –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö, –ù–ò –†–ê–ó–ú–ï–†–û–í, –ù–ò –õ–û–ì–û–¢–ò–ü–û–í - –ù–ò–ß–ï–ì–û!`;
    }

    // –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –∏ –∫–∞—á–µ—Å—Ç–≤—É
    finalPrompt += `\n\n=== –û–°–ù–û–í–ù–´–ï –ü–†–ê–í–ò–õ–ê ===
1. –¢–û–í–ê–†:
   - –°–¢–†–û–ì–û: –¢–æ–≤–∞—Ä –¥–æ–ª–∂–µ–Ω –≤—ã–≥–ª—è–¥–µ—Ç—å –¢–û–ß–ù–û –¢–ê–ö –ñ–ï, –∫–∞–∫ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ - –ù–ï –∏—Å–∫–∞–∂–∞–π –µ–≥–æ —Ñ–æ—Ä–º—É, —Ä–∞–∑–º–µ—Ä, –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
   - –°–¢–†–û–ì–û: –ù–ï –¥–µ–ª–∞–π —Ç–æ–≤–∞—Ä –º—É–ª—å—Ç—è—à–Ω—ã–º, –Ω–µ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º –∏–ª–∏ —Ñ–∞–Ω—Ç–∞—Å—Ç–∏—á–µ—Å–∫–∏–º - –æ–Ω –¥–æ–ª–∂–µ–Ω –≤—ã–≥–ª—è–¥–µ—Ç—å –†–ï–ê–õ–¨–ù–û –∏ –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–û
   - –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –¢–æ–≤–∞—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –¢–û–ú –ñ–ï –ø–æ–ª–æ–∂–µ–Ω–∏–∏, —á—Ç–æ –∏ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ - –ù–ï –º–µ–Ω—è–π –µ–≥–æ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é, –ù–ï –Ω–∞–∫–ª–æ–Ω—è–π, –ù–ï –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–π! –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä —Å—Ç–æ–∏—Ç - –æ–Ω –¥–æ–ª–∂–µ–Ω —Å—Ç–æ—è—Ç—å, –µ—Å–ª–∏ –ª–µ–∂–∏—Ç - –¥–æ–ª–∂–µ–Ω –ª–µ–∂–∞—Ç—å, –µ—Å–ª–∏ –≤–∏—Å–∏—Ç - –¥–æ–ª–∂–µ–Ω –≤–∏—Å–µ—Ç—å. –°–æ—Ö—Ä–∞–Ω–∏ –¢–û–ß–ù–û —Ç—É –∂–µ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é, —á—Ç–æ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏!
   - –†–∞–∑–º–µ—Å—Ç–∏ —Ç–æ–≤–∞—Ä –≥–∞—Ä–º–æ–Ω–∏—á–Ω–æ –≤ –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏, –Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏ –µ–≥–æ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é –∏ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –∫–∞–∫ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
   - –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ï—Å–ª–∏ –≤ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ —É–∫–∞–∑–∞–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï –õ–û–ì–ò–ß–ù–´ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–∫–µ–π—Ç–±–æ—Ä–¥ –¥–ª—è –≤–µ–¥—Ä–∞, –ª–µ–¥ –¥–ª—è –∫–∞—à–ø–æ), –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π –∏—Ö! –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ª–æ–≥–∏—á–Ω–æ —Å–≤—è–∑–∞–Ω—ã —Å —Ç–æ–≤–∞—Ä–æ–º
   - –¢–æ–≤–∞—Ä –¥–æ–ª–∂–µ–Ω –∑–∞–Ω–∏–º–∞—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ 50-60% –ø–ª–æ—â–∞–¥–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ (–ù–ï –±–æ–ª—å—à–µ)
   - –£–ª—É—á—à–∏ –∫–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: —á–µ—Ç–∫–æ—Å—Ç—å, –æ—Å–≤–µ—â–µ–Ω–∏–µ, —Ü–≤–µ—Ç–∞, –Ω–æ –°–û–•–†–ê–ù–ò —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –≤–∏–¥
   - –¢–æ–≤–∞—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ö–æ—Ä–æ—à–æ –≤–∏–¥–µ–Ω –∏ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª–µ–Ω

2. –¢–ï–ö–°–¢ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω):
   - –ó–∞–≥–æ–ª–æ–≤–æ–∫: —Ä–∞–∑–º–µ—Å—Ç–∏ –ö–†–ï–ê–¢–ò–í–ù–û - –º–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã (–æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç, –±–µ–π–¥–∂–∏, –ø–ª–∞—à–∫–∏, –Ω–µ–æ–±—ã—á–Ω—ã–µ —Ñ–æ—Ä–º—ã, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –≤ –∫–æ–º–ø–æ–∑–∏—Ü–∏—é)
   - –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞: –æ—Ç–æ–±—Ä–∞–∑–∏ –ö–†–ï–ê–¢–ò–í–ù–û - –∏—Å–ø–æ–ª—å–∑—É–π –±–µ–π–¥–∂–∏ —Å –∏–∫–æ–Ω–∫–∞–º–∏, –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–µ –ø–ª–∞—à–∫–∏, —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –±–ª–æ–∫–∏ —Å –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏, –Ω–µ–æ–±—ã—á–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ. –ù–ï –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ - —Å–¥–µ–ª–∞–π —ç—Ç–æ –í–ò–ó–£–ê–õ–¨–ù–û –ò–ù–¢–ï–†–ï–°–ù–´–ú!
   - –ü—Ä–æ—è–≤–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ - –ø—É—Å—Ç—å —ç—Ç–æ –±—É–¥–µ—Ç –∑–∞–ø–æ–º–∏–Ω–∞—é—â–∏–º—Å—è –∏ –Ω–µ–æ–±—ã—á–Ω—ã–º
   - –í–µ—Å—å —Ç–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–µ—Ç–∫–æ –≤–∏–¥–µ–Ω, –ù–ï –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å —Ç–æ–≤–∞—Ä
   - –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –í–°–ï–ì–î–ê –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –≥—Ä–∞–Ω–∏—Ü –∫–∞—Ä—Ç–æ—á–∫–∏, –ù–ï –≤—ã—Ö–æ–¥–∏—Ç—å –∑–∞ –∫—Ä–∞—è
   - –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è —Ç–µ–∫—Å—Ç–∞, —á—Ç–æ–±—ã –æ–Ω —Ö–æ—Ä–æ—à–æ —á–∏—Ç–∞–ª—Å—è
   - –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π

3. –§–û–ù –ò –î–ò–ó–ê–ô–ù:
   - –°–æ–∑–¥–∞–π –∫—Ä–∞—Å–∏–≤—ã–π, —Å—Ç–∏–ª—å–Ω—ã–π, –ü–†–û–î–£–ú–ê–ù–ù–´–ô –¥–∏–∑–∞–π–Ω –∫–∞—Ä—Ç–æ—á–∫–∏
   - –§–æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç–∏–ª—å–Ω—ã–º, –¥–æ–ø–æ–ª–Ω—è—Ç—å —Ç–æ–≤–∞—Ä, –ù–ï –ø—Ä–æ—Å—Ç—ã–º –æ–¥–Ω–æ—Ç–æ–Ω–Ω—ã–º
   - –ò—Å–ø–æ–ª—å–∑—É–π –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã, —Ç–µ–∫—Å—Ç—É—Ä—ã, –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
   - –í–ê–ñ–ù–û: –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –õ–û–ì–ò–ß–ù–´–ú–ò –∏ –°–û–û–¢–í–ï–¢–°–¢–í–û–í–ê–¢–¨ —Ç–æ–≤–∞—Ä—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –∫–∞—à–ø–æ - —Ä–∞—Å—Ç–µ–Ω–∏—è, –ø–æ—á–≤–∞, —Å–∞–¥–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –ù–ï —Å—Ç–µ–∫–ª–æ –∏ –ª–µ–¥)
   - –≠—Ç–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∏–º–µ–Ω–Ω–æ –ö–ê–†–¢–û–ß–ö–ê —Å –¥–∏–∑–∞–π–Ω–æ–º, –∞ –ù–ï –ø—Ä–æ—Å—Ç–æ —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞
   - –ü—Ä–æ—è–≤–∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ –¥–∏–∑–∞–π–Ω–µ, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º –∏ –†–ï–ê–õ–ò–°–¢–ò–ß–ù–û–°–¢–¨

=== üö´ –§–ò–ù–ê–õ–¨–ù–´–ô –ê–ë–°–û–õ–Æ–¢–ù–´–ô –ó–ê–ü–†–ï–¢ - –ü–†–û–ß–¢–ò –í–ù–ò–ú–ê–¢–ï–õ–¨–ù–û ===

–ü–ï–†–ï–î –ì–ï–ù–ï–†–ê–¶–ò–ï–ô –ü–†–û–ß–¢–ò –≠–¢–û–¢ –†–ê–ó–î–ï–õ - –≠–¢–û –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û!

–ó–ê–ü–†–ï–©–ï–ù–û –î–û–ë–ê–í–õ–Ø–¢–¨:
- ‚ùå –ù–ò–ö–ê–ö–û–ì–û –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –±—ã–ª —É–∫–∞–∑–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- ‚ùå –ù–ò–ö–ê–ö–ò–• –æ–ø–∏—Å–∞–Ω–∏–π —Ç–æ–≤–∞—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ø–ª–æ—Ç–Ω–æ—Å—Ç—å —á–µ—Ö–ª–∞ 180 g/m2")
- ‚ùå –ù–ò–ö–ê–ö–ò–• —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ø—Ä–æ—á–Ω—ã–π –∫–∞—Ä–∫–∞—Å")
- ‚ùå –ù–ò–ö–ê–ö–ò–• —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- ‚ùå –ù–ò–ö–ê–ö–ò–• —Ä–∞–∑–º–µ—Ä–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–†–∞–∑–º–µ—Ä–∞: 14,8 —Å–º" –∏–ª–∏ "–†–∞–∑–º–µ—Ä—ã: 125-1970")
- ‚ùå –ù–ò–ö–ê–ö–ò–• –ª–æ–≥–æ—Ç–∏–ø–æ–≤ –∏–ª–∏ –±—Ä–µ–Ω–¥–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "NIKA")
- ‚ùå –ù–ò–ö–ê–ö–û–ì–û —Ç–µ–∫—Å—Ç–∞ –ø–æ–¥ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞–º–∏
- ‚ùå –ù–ò–ö–ê–ö–û–ì–û —Ç–µ–∫—Å—Ç–∞ –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º
- ‚ùå –ù–ò–ö–ê–ö–û–ì–û —Ç–µ–∫—Å—Ç–∞ –≤ –ª—é–±–æ–º –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ –∫–∞—Ä—Ç–æ—á–∫–∏

–†–ê–ó–†–ï–®–ï–ù–û –¢–û–õ–¨–ö–û:
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¢–û–õ–¨–ö–û —Ç–æ—Ç —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª —É–∫–∞–∑–∞–Ω –≤—ã—à–µ
- ‚úÖ –ù–ò–ß–ï–ì–û –ë–û–õ–¨–®–ï!

–ï–°–õ–ò –¢–´ –î–û–ë–ê–í–ò–®–¨ –õ–Æ–ë–û–ô –¢–ï–ö–°–¢, –ö–û–¢–û–†–´–ô –ù–ï –ë–´–õ –£–ö–ê–ó–ê–ù - –≠–¢–û –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê!

=== –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø ===
- –í—Å–µ —Ç–µ–∫—Å—Ç—ã –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π
- –í—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –≥–æ—Ç–æ–≤–æ –¥–ª—è –ø–µ—á–∞—Ç–∏
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å—Ç—É–¥–∏–π–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ
- –ß–µ—Ç–∫–∏–µ –∫—Ä–∞—è, –±–µ–∑ —Ä–∞–∑–º—ã—Ç–∏—è
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ —Ç–æ–≤–∞—Ä–∞
- –ì–æ—Ç–æ–≤–æ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö (Ozon, Wildberries, –Ø–Ω–¥–µ–∫—Å –ú–∞—Ä–∫–µ—Ç)`;

    console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    console.log("üìù –ò–¢–û–ì–û–í–´–ô –ü–†–û–ú–ü–¢:");
    console.log(finalPrompt);
    console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    console.log("üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:");
    console.log("  - –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:", productName);
    console.log("  - Aspect Ratio:", aspectRatio || "3:4");
    console.log("  - –¢–µ–∫—Å—Ç –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ:", addText ? "–≤–∫–ª—é—á–µ–Ω" : "–≤—ã–∫–ª—é—á–µ–Ω");
    if (addText) {
      console.log("    - –ó–∞–≥–æ–ª–æ–≤–æ–∫:", title || productName);
      console.log("    - –ë—É–ª–ª–∏—Ç—ã:", bullets?.filter((b: string) => b && b.trim()).length || 0);
    }
    console.log("  - –†–µ—Ñ–µ—Ä–µ–Ω—Å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:", imageForApi ? (imageForApi.startsWith("data:") ? "base64" : "URL") : "–Ω–µ—Ç");
    if (imageForApi && imageForApi.startsWith("data:")) {
      const base64Preview = imageForApi.substring(0, 50) + "...";
      console.log("  - Base64 preview:", base64Preview);
      console.log("  - Base64 —Ä–∞–∑–º–µ—Ä:", Math.round(imageForApi.length / 1024), "KB");
    }
    console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ KIE (nano-banana-pro)
    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ aspectRatio –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (3:4 –∏–ª–∏ 1:1)
    const finalAspectRatio = aspectRatio === "1:1" ? "1:1" : "3:4";
    
    console.log("üìê Final Aspect Ratio:", finalAspectRatio);
    console.log("üñºÔ∏è Image Input:", imageForApi ? (imageForApi.startsWith("data:") ? "base64" : "URL") : "–Ω–µ—Ç");
    console.log("üìè –î–ª–∏–Ω–∞ –ø—Ä–æ–º–ø—Ç–∞:", finalPrompt.length, "—Å–∏–º–≤–æ–ª–æ–≤");
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ KIE —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º (–µ—Å–ª–∏ –µ—Å—Ç—å)
    let generatedImageUrl: string;
    
    try {
      const result = await generateWithKieAi(
        finalPrompt,
        imageForApi,
        finalAspectRatio,
        "png"
      );
      generatedImageUrl = result.imageUrl;
      console.log("‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞");
    } catch (error: any) {
      console.error("‚ùå –û—à–∏–±–∫–∞ –≤ generateWithKieAi:", error);
      throw new Error(`–ú–æ–¥–µ–ª—å –Ω–µ —Å–º–æ–≥–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –û—à–∏–±–∫–∞: ${error.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}`);
    }
    
    // –°–∫–∞—á–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    const generatedPath = await downloadImage(generatedImageUrl);
    const generatedLocalUrl = getPublicUrl(generatedPath);

    console.log(`‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞: ${generatedLocalUrl}`);

    return NextResponse.json({
      success: true,
      imageUrl: generatedLocalUrl,
      message: "–ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞!",
    });

  } catch (error: unknown) {
    const err = error as { message?: string };
    const errorString = String(err?.message ?? error);
    console.error("‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:", error);

    if (isSupabaseNetworkError(error) || errorString.includes("fetch failed") || errorString.includes("timeout") || errorString.includes("ECONNREFUSED") || errorString.includes("ETIMEDOUT")) {
      return NextResponse.json({
        success: false,
        error: "–°–µ—Ä–≤–∏—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
        code: "SERVICE_UNAVAILABLE",
      }, { status: 503 });
    }

    let errorMessage = "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏";
    if (errorString.includes("401") || errorString.includes("Unauthorized")) {
      errorMessage = "–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ KIE_AI_API_KEY";
    } else if (errorString.includes("429")) {
      errorMessage = "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –º–∏–Ω—É—Ç—É.";
    } else if (errorString.includes("insufficient") || errorString.includes("402")) {
      errorMessage = "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ KIE";
    }

    return NextResponse.json({
      success: false,
      error: errorMessage,
      details: errorString,
    }, { status: 500 });
  }
}
