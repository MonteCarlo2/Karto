import { NextRequest, NextResponse } from "next/server";
import { generateWithKieAi } from "@/lib/services/kie-ai";
import { 
  downloadImage, 
  getPublicUrl,
} from "@/lib/services/image-processing";
import path from "path";
import fs from "fs/promises";
import { createServerClient } from "@/lib/supabase/server";
import { getVisualQuota, incrementVisualQuota } from "@/lib/services/visual-generation-quota";

/**
 * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª–∞–π–¥–∞ –¥–ª—è —Å–µ—Ä–∏–∏ –∫–∞—Ä—Ç–æ—á–µ–∫
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—Ç –∂–µ —Ç–æ–≤–∞—Ä (—Ä–µ—Ñ–µ—Ä–µ–Ω—Å –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Å–ª–∞–π–¥–∞), –Ω–æ —Å –Ω–æ–≤–æ–π –æ–±—Å—Ç–∞–Ω–æ–≤–∫–æ–π/—Å—Ü–µ–Ω–∞—Ä–∏–µ–º
 */
export async function POST(request: NextRequest) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ API –∫–ª—é—á–∞
  if (!process.env.KIE_AI_API_KEY && !process.env.KIE_API_KEY) {
    return NextResponse.json({
      success: false,
      error: "KIE_AI_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω",
      details: "–î–æ–±–∞–≤—å—Ç–µ KIE_AI_API_KEY (–∏–ª–∏ KIE_API_KEY) –≤ —Ñ–∞–π–ª .env.local",
    }, { status: 500 });
  }

  try {
    const body = await request.json();
    
    const {
      sessionId,
      productName,
      referenceImageUrl, // –†–µ—Ñ–µ—Ä–µ–Ω—Å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Å–ª–∞–π–¥–∞
      environmentImageUrl, // –†–µ—Ñ–µ—Ä–µ–Ω—Å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Å–ª–∞–π–¥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      userPrompt, // –û–ø–∏—Å–∞–Ω–∏–µ –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      scenario, // –°—Ü–µ–Ω–∞—Ä–∏–π: "studio", "living-space", "macro", "in-hands"
      aspectRatio, // "3:4" | "4:3" | "9:16" | "1:1"
    } = body;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
    if (!productName) {
      return NextResponse.json(
        { success: false, error: "–¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" },
        { status: 400 }
      );
    }

    if (!referenceImageUrl) {
      return NextResponse.json(
        { success: false, error: "–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" },
        { status: 400 }
      );
    }
    if (!sessionId) {
      return NextResponse.json(
        { success: false, error: "sessionId –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏–∑—É–∞–ª–∞" },
        { status: 400 }
      );
    }

    const supabase = createServerClient();
    const quotaBefore = await getVisualQuota(supabase as any, sessionId);
    if (quotaBefore.remaining <= 0) {
      return NextResponse.json(
        {
          success: false,
          error: "–õ–∏–º–∏—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –≤ –ü–æ—Ç–æ–∫–µ –∏—Å—á–µ—Ä–ø–∞–Ω (0 –∏–∑ 12).",
          code: "VISUAL_LIMIT_REACHED",
          generationUsed: quotaBefore.used,
          generationRemaining: quotaBefore.remaining,
          generationLimit: quotaBefore.limit,
        },
        { status: 403 }
      );
    }

    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è API (—Ç–æ–≤–∞—Ä + –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∞)
    // –î–ª—è KIE –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å base64 –∏–ª–∏ URL, —Å–µ—Ä–≤–∏—Å —Å–∞–º –∑–∞–≥—Ä—É–∑–∏—Ç –∏—Ö –≤ file upload endpoint.
    let imagesForApi: string[] = [];
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ data URL (KIE –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ data URL –∏–ª–∏ –ø—É–±–ª–∏—á–Ω—ã–π https ‚Äî –±–µ–∑ localhost)
    const convertImageToBase64 = async (imageUrl: string): Promise<string | null> => {
      try {
        // –ï—Å–ª–∏ —ç—Ç–æ base64, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –µ—Å—Ç—å
        if (imageUrl.startsWith("data:")) {
          const base64Size = imageUrl.length;
          const maxSize = 10 * 1024 * 1024; // 10MB
          if (base64Size > maxSize) {
            console.warn("‚ö†Ô∏è Base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ");
            return null;
          }
          return imageUrl;
        }
        
        // –ï—Å–ª–∏ —ç—Ç–æ http(s) localhost ‚Äî —á–∏—Ç–∞–µ–º —Å –¥–∏—Å–∫–∞ –∏ –æ—Ç–¥–∞—ë–º data URL (KIE –Ω–µ –¥–µ—Ä–≥–∞–µ—Ç localhost)
        if (imageUrl.startsWith("http://") || imageUrl.startsWith("https://")) {
          try {
            const u = new URL(imageUrl);
            if (u.hostname === "localhost" || u.hostname === "127.0.0.1") {
              const localPath = path.join(process.cwd(), "public", u.pathname);
              await fs.access(localPath);
              const buffer = await fs.readFile(localPath);
              if (buffer.length > 10 * 1024 * 1024) return null;
              let mimeType = "image/jpeg";
              const header = buffer.slice(0, 4);
              if (header[0] === 0x89 && header[1] === 0x50 && header[2] === 0x4E && header[3] === 0x47) mimeType = "image/png";
              else if (header[0] === 0xFF && header[1] === 0xD8 && header[2] === 0xFF) mimeType = "image/jpeg";
              else {
                const ext = path.extname(u.pathname).toLowerCase();
                if (ext === ".png") mimeType = "image/png";
                else if (ext === ".webp") mimeType = "image/webp";
              }
              return `data:${mimeType};base64,${buffer.toString("base64")}`;
            }
          } catch (_) { /* fallback: use URL as is */ }
          return imageUrl;
        }
        
        // –ï—Å–ª–∏ —ç—Ç–æ –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—É—Ç—å, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64
        const localPath = imageUrl.startsWith("/") 
          ? path.join(process.cwd(), "public", imageUrl)
          : imageUrl;
        
        await fs.access(localPath);
        const buffer = await fs.readFile(localPath);
        const fileSize = buffer.length;
        
        if (fileSize > 10 * 1024 * 1024) {
          console.warn("‚ö†Ô∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ");
          return null;
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º MIME-—Ç–∏–ø
        let mimeType = "image/jpeg";
        const header = buffer.slice(0, 4);
        
        if (header[0] === 0x89 && header[1] === 0x50 && header[2] === 0x4E && header[3] === 0x47) {
          mimeType = "image/png";
        } else if (header[0] === 0xFF && header[1] === 0xD8 && header[2] === 0xFF) {
          mimeType = "image/jpeg";
        } else {
          const ext = path.extname(imageUrl).toLowerCase();
          if (ext === ".png") mimeType = "image/png";
          else if (ext === ".jpg" || ext === ".jpeg") mimeType = "image/jpeg";
          else if (ext === ".webp") mimeType = "image/webp";
        }
        
        const base64 = buffer.toString("base64");
        return `data:${mimeType};base64,${base64}`;
      } catch (error) {
        console.warn("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:", error);
        return null;
      }
    };
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ—Ñ–µ—Ä–µ–Ω—Å —Ç–æ–≤–∞—Ä–∞
    if (referenceImageUrl) {
      const productRef = await convertImageToBase64(referenceImageUrl);
      if (productRef) {
        imagesForApi.push(productRef);
        console.log("üì∑ –†–µ—Ñ–µ—Ä–µ–Ω—Å —Ç–æ–≤–∞—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω");
      }
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ—Ñ–µ—Ä–µ–Ω—Å –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∏ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
    if (environmentImageUrl) {
      const envRef = await convertImageToBase64(environmentImageUrl);
      if (envRef) {
        imagesForApi.push(envRef);
        console.log("üì∑ –†–µ—Ñ–µ—Ä–µ–Ω—Å –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω");
      }
    }

    // –û–±—Å—Ç–∞–Ω–æ–≤–∫–∞: –ª–∏–±–æ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å –≤—Ç–æ—Ä–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –ª–∏–±–æ —è–≤–Ω—ã–π –∑–∞–ø—Ä–µ—Ç –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ–Ω —Å –ø–µ—Ä–≤–æ–≥–æ
    let environmentReference = "";
    if (environmentImageUrl) {
      environmentReference = `\n\n=== –†–ï–§–ï–†–ï–ù–° –û–ë–°–¢–ê–ù–û–í–ö–ò ===
–°–¢–†–û–ì–û –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–µ –≤—Ç–æ—Ä–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∫ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∏/—Ñ–æ–Ω–∞.
- –°–æ—Ö—Ä–∞–Ω–∏ –¢–£ –ñ–ï –æ–±—Å—Ç–∞–Ω–æ–≤–∫—É, —Ñ–æ–Ω, –æ—Å–≤–µ—â–µ–Ω–∏–µ, —Å—Ç–∏–ª—å, —á—Ç–æ –Ω–∞ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∏
- –¢–æ–≤–∞—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω –≤ –¢–û–ô –ñ–ï –æ–±—Å—Ç–∞–Ω–æ–≤–∫–µ, —á—Ç–æ –Ω–∞ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
- –ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ –∂–µ –ø—Ä–µ–¥–º–µ—Ç—ã –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞, –¥–µ–∫–æ—Ä, —Ñ–æ–Ω, –µ—Å–ª–∏ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ
- –°–æ—Ö—Ä–∞–Ω–∏ –æ–±—â–∏–π —Å—Ç–∏–ª—å –∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∏`;
    } else {
      environmentReference = `\n\n=== –ù–ï –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –û–ë–°–¢–ê–ù–û–í–ö–£ –° –†–ï–§–ï–†–ï–ù–°–ê ===
–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ù–∞ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–µ –ø–µ—Ä–µ–¥–∞–Ω —Ç–æ–ª—å–∫–æ –û–î–ò–ù —Å–Ω–∏–º–æ–∫ (—Ç–æ–≤–∞—Ä –Ω–∞ —Ñ–æ–Ω–µ). –ù–ï –∫–æ–ø–∏—Ä—É–π —Å –Ω–µ–≥–æ –æ–±—Å—Ç–∞–Ω–æ–≤–∫—É, —Ñ–æ–Ω, –¥–µ–∫–æ—Ä –∏–ª–∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ. –ò–≥–Ω–æ—Ä–∏—Ä—É–π —Ñ–æ–Ω –Ω–∞ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é. –°–æ–∑–¥–∞–π –ù–û–í–£–Æ –æ–±—Å—Ç–∞–Ω–æ–≤–∫—É –°–¢–†–û–ì–û –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é —Å—ä–µ–º–∫–∏ –Ω–∏–∂–µ.`;
    }

    // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ü–µ–Ω–∞—Ä–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è)
    let scenarioPrompt = "";
    
    switch (scenario) {
      case "studio":
        scenarioPrompt = `–°–¢–£–î–ò–ô–ù–´–ô –ü–û–î–ò–£–ú: –¢–æ–≤–∞—Ä "${productName}" –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º —Å—Ç—É–¥–∏–π–Ω–æ–º –ø–æ–¥–∏—É–º–µ –∏–ª–∏ —Å—Ç–µ–Ω–¥–µ. –§–æ–Ω - —á–∏—Å—Ç—ã–π —Å—Ç—É–¥–∏–π–Ω—ã–π —Ñ–æ–Ω (–±–µ–ª—ã–π, —Å–µ—Ä—ã–π –∏–ª–∏ —á–µ—Ä–Ω—ã–π). –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å—Ç—É–¥–∏–π–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ —Å –º—è–≥–∫–∏–º–∏ —Ç–µ–Ω—è–º–∏. –¢–æ–≤–∞—Ä –æ–¥–∏–Ω, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤. –°—Ç–∏–ª—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π —Å—Ç—É–¥–∏–π–Ω–æ–π —Å—ä–µ–º–∫–∏ –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞.`;
        break;
      case "living-space":
        scenarioPrompt = `–ñ–ò–õ–û–ï –ü–†–û–°–¢–†–ê–ù–°–¢–í–û: –¢–æ–≤–∞—Ä "${productName}" –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –¥–æ–º–∞—à–Ω–µ–π –æ–±—Å—Ç–∞–Ω–æ–≤–∫–µ, –≤ –∂–∏–ª–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ. –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è –¥–æ–º–∞—à–Ω—è—è –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏ –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞, –º–µ–±–µ–ª—å—é, –¥–µ–∫–æ—Ä–æ–º. –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ, —É—é—Ç–Ω–∞—è –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞. –¢–æ–≤–∞—Ä –æ—Ä–≥–∞–Ω–∏—á–Ω–æ –≤–ø–∏—Å–∞–Ω –≤ –∏–Ω—Ç–µ—Ä—å–µ—Ä, –≤—ã–≥–ª—è–¥–∏—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –≤ –¥–æ–º–∞—à–Ω–µ–π –æ–±—Å—Ç–∞–Ω–æ–≤–∫–µ.`;
        break;
      case "macro":
        scenarioPrompt = `–ú–ê–ö–†–û-–î–ï–¢–ê–õ–¨: –¢–æ–≤–∞—Ä "${productName}" —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞–Ω –∫—Ä—É–ø–Ω—ã–º –ø–ª–∞–Ω–æ–º (–º–∞–∫—Ä–æ-—Å—ä–µ–º–∫–∞). –î–µ—Ç–∞–ª–∏ —Ç–æ–≤–∞—Ä–∞ –≤–∏–¥–Ω—ã –æ—á–µ–Ω—å —á–µ—Ç–∫–æ, –∫—Ä—É–ø–Ω–æ. –§–æ–∫—É—Å –Ω–∞ –¥–µ—Ç–∞–ª—è—Ö —Ç–æ–≤–∞—Ä–∞. –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –º–∞–∫—Ä–æ-—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è —Å —á–µ—Ç–∫–∏–º–∏ –¥–µ—Ç–∞–ª—è–º–∏.`;
        break;
      case "with-person":
        scenarioPrompt = `–° –ß–ï–õ–û–í–ï–ö–û–ú: –¢–æ–≤–∞—Ä "${productName}" –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–∞–¥—Ä–µ —Å —á–µ–ª–æ–≤–µ–∫–æ–º. –ß–µ–ª–æ–≤–µ–∫ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –∫–∞–¥—Ä–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –º–æ–∂–µ—Ç –¥–µ—Ä–∂–∞—Ç—å —Ç–æ–≤–∞—Ä, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è —Ä—è–¥–æ–º. –ï—Å–ª–∏ —ç—Ç–æ –æ–¥–µ–∂–¥–∞ - —á–µ–ª–æ–≤–µ–∫ –ø—Ä–∏–º–µ—Ä—è–µ—Ç –µ—ë. –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —á–µ–ª–æ–≤–µ–∫, –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ø–æ–∑–∞. –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ, —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∞.`;
        break;
      default:
        scenarioPrompt = `–¢–æ–≤–∞—Ä "${productName}" –≤ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–π –æ–±—Å—Ç–∞–Ω–æ–≤–∫–µ, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –µ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—é.`;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –µ—Å—Ç—å
    let userDescription = "";
    let requestedText = "";
    if (userPrompt && userPrompt.trim()) {
      // –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ –ø—Ä–æ—Å–∏—Ç –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç
      // –ò—â–µ–º —è–≤–Ω—ã–µ —É–∫–∞–∑–∞–Ω–∏—è –Ω–∞ —Ç–µ–∫—Å—Ç: "–¥–æ–±–∞–≤—å —Ç–µ–∫—Å—Ç", "–Ω–∞–ø–∏—à–∏", "–Ω–∞–¥–ø–∏—Å—å", "–ø–æ–¥–ø–∏—Å—å", "–Ω–∞–∑–≤–∞–Ω–∏–µ", "–∑–∞–≥–æ–ª–æ–≤–æ–∫"
      const textKeywords = /(?:–¥–æ–±–∞–≤—å|–Ω–∞–ø–∏—à–∏|—Ç–µ–∫—Å—Ç|–Ω–∞–¥–ø–∏—Å—å|–ø–æ–¥–ø–∏—Å—å|–Ω–∞–∑–≤–∞–Ω–∏–µ|–∑–∞–≥–æ–ª–æ–≤–æ–∫|—Å–¥–µ–ª–∞–π\s+–Ω–∞–¥–ø–∏—Å—å|—Å–¥–µ–ª–∞–π\s+—Ç–µ–∫—Å—Ç)/i;
      const hasTextRequest = textKeywords.test(userPrompt);
      
      if (hasTextRequest) {
        // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ –∫–∞–≤—ã—á–µ–∫ –∏–ª–∏ –ø–æ—Å–ª–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
        const textMatch = userPrompt.match(/(?:–¥–æ–±–∞–≤—å|–Ω–∞–ø–∏—à–∏|—Ç–µ–∫—Å—Ç|–Ω–∞–¥–ø–∏—Å—å|–ø–æ–¥–ø–∏—Å—å|–Ω–∞–∑–≤–∞–Ω–∏–µ|–∑–∞–≥–æ–ª–æ–≤–æ–∫|—Å–¥–µ–ª–∞–π\s+–Ω–∞–¥–ø–∏—Å—å|—Å–¥–µ–ª–∞–π\s+—Ç–µ–∫—Å—Ç)[\s:]+["']?([^"']+)["']?/i);
        if (textMatch && textMatch[1]) {
          requestedText = textMatch[1].trim();
        } else {
          // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–∞–≤—ã—á–∫–∞—Ö, –∏—â–µ–º –ø–æ—Å–ª–µ –¥–≤–æ–µ—Ç–æ—á–∏—è –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –±–µ—Ä–µ–º —á–∞—Å—Ç—å –ø–æ—Å–ª–µ –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞
          const afterKeyword = userPrompt.replace(textKeywords, "").trim();
          if (afterKeyword) {
            requestedText = afterKeyword.split(/[.,;!?]/)[0].trim(); // –ë–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
          }
        }
        userDescription = `\n\n–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:\n${userPrompt.trim()}\n\n–í–ê–ñ–ù–û: –†–µ–∞–ª–∏–∑—É–π —ç—Ç–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, –Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π –≤—ã—à–µ.`;
      } else {
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –ø—Ä–æ—Å–∏—Ç —Ç–µ–∫—Å—Ç —è–≤–Ω–æ, –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–µ–º, —á—Ç–æ —Ç–µ–∫—Å—Ç –ù–ï –Ω—É–∂–µ–Ω
        userDescription = `\n\n–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:\n${userPrompt.trim()}\n\n–í–ê–ñ–ù–û: –†–µ–∞–ª–∏–∑—É–π —ç—Ç–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, –Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π –≤—ã—à–µ. –ù–ï –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, –Ω–∞–¥–ø–∏—Å–µ–π, –ª–æ–≥–æ—Ç–∏–ø–æ–≤ - —ç—Ç–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å—Ç–∞—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –±–µ–∑ —Ç–µ–∫—Å—Ç–∞.`;
      }
    }

    // –°—Ç—Ä–æ–∏–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    const finalPrompt = `–°–æ–∑–¥–∞–π –†–ï–ê–õ–ò–°–¢–ò–ß–ù–£–Æ –§–û–¢–û–ì–†–ê–§–ò–Æ —Ç–æ–≤–∞—Ä–∞ "${productName}".

üö´ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –≠–¢–û –§–û–¢–û–ì–†–ê–§–ò–Ø, –ù–ï –ö–ê–†–¢–û–ß–ö–ê:
- –ù–ï —Å–æ–∑–¥–∞–≤–∞–π –∫–∞—Ä—Ç–æ—á–∫—É —Å –¥–∏–∑–∞–π–Ω–æ–º, –∏–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–æ–π –∏–ª–∏ —Ç–µ–∫—Å—Ç–æ–º
- –ù–ï –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, –Ω–∞–¥–ø–∏—Å–µ–π, –ª–æ–≥–æ—Ç–∏–ø–æ–≤, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫, —Ä–∞–∑–º–µ—Ä–æ–≤
- –≠—Ç–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –†–ï–ê–õ–ò–°–¢–ò–ß–ù–ê–Ø –§–û–¢–û–ì–†–ê–§–ò–Ø, –∫–∞–∫ –±—É–¥—Ç–æ —Å–Ω—è—Ç–∞—è –∫–∞–º–µ—Ä–æ–π
- –í—ã—Å–æ–∫–∏–π —Ä–µ–∞–ª–∏–∑–º: –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ, —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ —Ç–µ–Ω–∏, –æ—Ç—Ä–∞–∂–µ–Ω–∏—è, —Ç–µ–∫—Å—Ç—É—Ä—ã, –Ω–µ–±–æ–ª—å—à–∏–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–µ—Ñ–µ–∫—Ç—ã
- –î–æ–ª–∂–Ω–æ –≤—ã–≥–ª—è–¥–µ—Ç—å –∫–∞–∫ —Ä–µ–∞–ª—å–Ω–∞—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è, –∞ –ù–ï –∫–∞–∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

=== –†–ï–§–ï–†–ï–ù–°–ù–û–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ï –¢–û–í–ê–†–ê ===
–°–¢–†–û–ì–û –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∫–∞–∫ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å.
- –¢–æ–≤–∞—Ä –¥–æ–ª–∂–µ–Ω –≤—ã–≥–ª—è–¥–µ—Ç—å –¢–û–ß–ù–û –¢–ê–ö –ñ–ï, –∫–∞–∫ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
- –ù–ï –∏—Å–∫–∞–∂–∞–π –µ–≥–æ —Ñ–æ—Ä–º—É, —Ä–∞–∑–º–µ—Ä, –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏, –û–†–ò–ï–ù–¢–ê–¶–ò–Æ, –†–ê–ö–£–†–°
- –¢–æ–≤–∞—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –¢–û–ú –ñ–ï –ø–æ–ª–æ–∂–µ–Ω–∏–∏ –∏ —Å –¢–û–ì–û –ñ–ï —Ä–∞–∫—É—Ä—Å–∞, —á—Ç–æ –∏ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏:
  * –ï—Å–ª–∏ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä –ø–æ–∫–∞–∑–∞–Ω —Å–±–æ–∫—É - –ø–æ–∫–∞–∂–∏ –µ–≥–æ —Å–±–æ–∫—É, –ù–ï —Å–≤–µ—Ä—Ö—É –∏ –ù–ï —Å–∑–∞–¥–∏!
  * –ï—Å–ª–∏ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä –ø–æ–∫–∞–∑–∞–Ω —Å–ø–µ—Ä–µ–¥–∏ - –ø–æ–∫–∞–∂–∏ –µ–≥–æ —Å–ø–µ—Ä–µ–¥–∏, –ù–ï —Å–±–æ–∫—É –∏ –ù–ï —Å–≤–µ—Ä—Ö—É!
  * –ï—Å–ª–∏ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä –ø–æ–∫–∞–∑–∞–Ω —Å–≤–µ—Ä—Ö—É - –ø–æ–∫–∞–∂–∏ –µ–≥–æ —Å–≤–µ—Ä—Ö—É, –ù–ï —Å–±–æ–∫—É –∏ –ù–ï —Å–∑–∞–¥–∏!
  * –ù–ï –º–µ–Ω—è–π —Ä–∞–∫—É—Ä—Å —Å—ä–µ–º–∫–∏ - –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–¢ –ñ–ï —Ä–∞–∫—É—Ä—Å, —á—Ç–æ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏!
- –ù–ï –¥–µ–ª–∞–π —Ç–æ–≤–∞—Ä –º—É–ª—å—Ç—è—à–Ω—ã–º, –Ω–µ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º –∏–ª–∏ —Ñ–∞–Ω—Ç–∞—Å—Ç–∏—á–µ—Å–∫–∏–º - –æ–Ω –¥–æ–ª–∂–µ–Ω –≤—ã–≥–ª—è–¥–µ—Ç—å –†–ï–ê–õ–¨–ù–û
- –ù–ï –Ω–∞–∫–ª–æ–Ω—è–π —Ç–æ–≤–∞—Ä, –ù–ï –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–π –µ–≥–æ - —Å–æ—Ö—Ä–∞–Ω–∏ –¢–û–ß–ù–û —Ç—É –∂–µ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é, —á—Ç–æ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏!
- –¢–æ–≤–∞—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∑–Ω–∞–≤–∞–µ–º—ã–º –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∏—Å—Ö–æ–¥–Ω–æ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é –∏ –Ω–∞–∑–≤–∞–Ω–∏—é "${productName}"

=== –°–¶–ï–ù–ê–†–ò–ô –°–™–ï–ú–ö–ò (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ü–†–ò–ú–ï–ù–ò) ===
–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –°—Ü–µ–Ω–∞—Ä–∏–π –Ω–∏–∂–µ –û–ë–Ø–ó–ê–¢–ï–õ–ï–ù –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é. –ù–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–π –µ–≥–æ. –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–∂–µ–Ω —Å—Ç—Ä–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏—é.
${scenarioPrompt}${environmentReference}${userDescription}
–§–ò–ù–ê–õ–¨–ù–û–ï –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï: –ò—Ç–æ–≥–æ–≤–∞—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –¥–æ–ª–∂–Ω–∞ —Å—Ç—Ä–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Å—Ü–µ–Ω–∞—Ä–∏—é —Å—ä–µ–º–∫–∏ –≤—ã—à–µ.

=== –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê ===
1. –¢–û–í–ê–†:
   - –°–¢–†–û–ì–û: –¢–æ–≤–∞—Ä –¥–æ–ª–∂–µ–Ω –≤—ã–≥–ª—è–¥–µ—Ç—å –¢–û–ß–ù–û –¢–ê–ö –ñ–ï, –∫–∞–∫ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
   - –°–¢–†–û–ì–û: –ù–ï –º–µ–Ω—è–π —Ä–∞–∫—É—Ä—Å, –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é, –ø–æ–ª–æ–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
   - –°–¢–†–û–ì–û: –ù–ï –Ω–∞–∫–ª–æ–Ω—è–π —Ç–æ–≤–∞—Ä, –ù–ï –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–π –µ–≥–æ
   - –†–∞–∑–º–µ—Å—Ç–∏ —Ç–æ–≤–∞—Ä –õ–û–ì–ò–ß–ù–û –∏ –ü–†–ê–í–ò–õ–¨–ù–û –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å–æ —Å—Ü–µ–Ω–∞—Ä–∏–µ–º
   - –¢–æ–≤–∞—Ä –¥–æ–ª–∂–µ–Ω –∑–∞–Ω–∏–º–∞—Ç—å –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—É—é —á–∞—Å—Ç—å –∫–∞–¥—Ä–∞ (50-70%)
   - –í—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —á–µ—Ç–∫–æ—Å—Ç—å, —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å

2. –¢–ï–ö–°–¢:
   ${requestedText 
     ? `- ‚úÖ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –Ø–í–ù–û –ü–û–ü–†–û–°–ò–õ –î–û–ë–ê–í–ò–¢–¨ –¢–ï–ö–°–¢: "${requestedText}"
   - –î–æ–±–∞–≤—å –¢–û–õ–¨–ö–û —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç, –ù–ò–ß–ï–ì–û –ë–û–õ–¨–®–ï
   - –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π, —á–µ—Ç–∫–æ –∏ —á–∏—Ç–∞–µ–º–æ
   - –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ä–≥–∞–Ω–∏—á–Ω–æ –≤–ø–∏—Å–∞–Ω –≤ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é, –Ω–µ –≤—ã–≥–ª—è–¥–µ—Ç—å –∫–∞–∫ –Ω–∞–∫–ª–µ–π–∫–∞
   - üö´ –ó–ê–ü–†–ï–©–ï–ù–û –¥–æ–±–∞–≤–ª—è—Ç—å –ª—é–±–æ–π –¥—Ä—É–≥–æ–π —Ç–µ–∫—Å—Ç, –∫—Ä–æ–º–µ "${requestedText}"`
     : `- üö´ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ù–ï –¥–æ–±–∞–≤–ª—è–π –ù–ò–ö–ê–ö–û–ì–û —Ç–µ–∫—Å—Ç–∞, –Ω–∞–¥–ø–∏—Å–µ–π, –ª–æ–≥–æ—Ç–∏–ø–æ–≤, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫, —Ä–∞–∑–º–µ—Ä–æ–≤, –Ω–∞–∑–≤–∞–Ω–∏–π, –ø–æ–¥–ø–∏—Å–µ–π
   - –≠—Ç–æ –§–û–¢–û–ì–†–ê–§–ò–Ø, –∞ –Ω–µ –∫–∞—Ä—Ç–æ—á–∫–∞ —Å —Ç–µ–∫—Å—Ç–æ–º
   - –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ç–µ–∫—Å—Ç –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –±—ã–ª –Ω–∞ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
   - –ù–ï –¥–æ–±–∞–≤–ª—è–π —Ç–µ–∫—Å—Ç –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –∫–∞–∂–µ—Ç—Å—è —É–º–µ—Å—Ç–Ω—ã–º
   - –≠—Ç–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ß–ò–°–¢–ê–Ø –§–û–¢–û–ì–†–ê–§–ò–Ø –±–µ–∑ —Ç–µ–∫—Å—Ç–∞`}

3. –†–ï–ê–õ–ò–°–¢–ò–ß–ù–û–°–¢–¨:
   - –î–æ–ª–∂–Ω–æ –≤—ã–≥–ª—è–¥–µ—Ç—å –∫–∞–∫ –†–ï–ê–õ–¨–ù–ê–Ø –§–û–¢–û–ì–†–ê–§–ò–Ø, —Å–Ω—è—Ç–∞—è –∫–∞–º–µ—Ä–æ–π
   - –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ, —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ —Ç–µ–Ω–∏, –æ—Ç—Ä–∞–∂–µ–Ω–∏—è, —Ç–µ–∫—Å—Ç—É—Ä—ã
   - –ù–µ–±–æ–ª—å—à–∏–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–µ—Ñ–µ–∫—Ç—ã (–ø—ã–ª—å, —Ü–∞—Ä–∞–ø–∏–Ω—ã, –æ—Ç–ø–µ—á–∞—Ç–∫–∏ –ø–∞–ª—å—Ü–µ–≤) –¥–ª—è —Ä–µ–∞–ª–∏–∑–º–∞
   - –ò–∑–±–µ–≥–∞–π "–∏–¥–µ–∞–ª—å–Ω–æ—Å—Ç–∏" - —Å–¥–µ–ª–∞–π —Ç–∞–∫, —á—Ç–æ–±—ã –≤—ã–≥–ª—è–¥–µ–ª–æ –∫–∞–∫ —Ä–µ–∞–ª—å–Ω–∞—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è

4. –ö–ê–ß–ï–°–¢–í–û:
   - –í—ã—Å–æ–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ, –≥–æ—Ç–æ–≤–æ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
   - –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ —Å—ä–µ–º–∫–∏
   - –ß–µ—Ç–∫–∏–µ –∫—Ä–∞—è, –±–µ–∑ —Ä–∞–∑–º—ã—Ç–∏—è
   - –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ —Ç–æ–≤–∞—Ä–∞`;

    console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    console.log("üìù –ü–†–û–ú–ü–¢ –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –°–õ–ê–ô–î–ê:");
    console.log(finalPrompt);
    console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    console.log("üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:");
    console.log("  - –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:", productName);
    console.log("  - –°—Ü–µ–Ω–∞—Ä–∏–π:", scenario || "–Ω–µ –≤—ã–±—Ä–∞–Ω");
    console.log("  - –û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", userPrompt || "–Ω–µ—Ç");
    console.log("  - Aspect Ratio:", aspectRatio || "3:4");
    console.log("  - –†–µ—Ñ–µ—Ä–µ–Ω—Å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:", imagesForApi.length);
    console.log("  - –†–µ—Ñ–µ—Ä–µ–Ω—Å —Ç–æ–≤–∞—Ä–∞:", referenceImageUrl ? "–¥–∞" : "–Ω–µ—Ç");
    console.log("  - –†–µ—Ñ–µ—Ä–µ–Ω—Å –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∏:", environmentImageUrl ? "–¥–∞" : "–Ω–µ—Ç");
    console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ KIE (nano-banana-pro)
    const finalAspectRatio = aspectRatio || "3:4";
    
    console.log("üìê Final Aspect Ratio:", finalAspectRatio);
    console.log("üñºÔ∏è Image Inputs:", imagesForApi.length);
    console.log("üìè –î–ª–∏–Ω–∞ –ø—Ä–æ–º–ø—Ç–∞:", finalPrompt.length, "—Å–∏–º–≤–æ–ª–æ–≤");
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ KIE —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º(—è–º–∏)
    let generatedImageUrl: string;
    
    try {
      const result = await generateWithKieAi(
        finalPrompt,
        imagesForApi.length > 0 ? (imagesForApi.length === 1 ? imagesForApi[0] : imagesForApi) : undefined,
        finalAspectRatio,
        "png"
      );
      generatedImageUrl = result.imageUrl;
      console.log("‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞");
    } catch (error: any) {
      console.error("‚ùå –û—à–∏–±–∫–∞ –≤ generateWithKieAi:", error);
      throw new Error(`–ú–æ–¥–µ–ª—å –Ω–µ —Å–º–æ–≥–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –û—à–∏–±–∫–∞: ${error.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}`);
    }
    
    // –°–∫–∞—á–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    const generatedPath = await downloadImage(generatedImageUrl);
    const generatedLocalUrl = getPublicUrl(generatedPath);

    console.log(`‚úÖ –°–ª–∞–π–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: ${generatedLocalUrl}`);

    const quotaAfter = await incrementVisualQuota(supabase as any, sessionId, 1);

    return NextResponse.json({
      success: true,
      imageUrl: generatedLocalUrl,
      message: "–°–ª–∞–π–¥ —Å–æ–∑–¥–∞–Ω!",
      generationUsed: quotaAfter.used,
      generationRemaining: quotaAfter.remaining,
      generationLimit: quotaAfter.limit,
    });

  } catch (error: any) {
    console.error("‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª–∞–π–¥–∞:", error);
    
    let errorMessage = "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏";
    const errorString = String(error);
    
    if (errorString.includes("401") || errorString.includes("Unauthorized")) {
      errorMessage = "–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ KIE_AI_API_KEY";
    } else if (errorString.includes("429")) {
      errorMessage = "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –º–∏–Ω—É—Ç—É.";
    } else if (errorString.includes("insufficient") || errorString.includes("402")) {
      errorMessage = "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ KIE";
    }
    
    return NextResponse.json({
      success: false,
      error: errorMessage,
      details: errorString,
    }, { status: 500 });
  }
}
