/**
 * –°–µ—Ä–≤–∏—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤ —á–µ—Ä–µ–∑ OpenRouter API
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Claude 4.5 Sonnet —á–µ—Ä–µ–∑ OpenRouter –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–ø–∏—Å–∞–Ω–∏–π
 */

// –ü–æ–ª—É—á–∞–µ–º API –∫–ª—é—á –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π (–µ—Å–ª–∏ –µ—Å—Ç—å)
const OPENROUTER_API_KEY = process.env.OPENROUTER_API_KEY || "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";
const OPENROUTER_API_URL = "https://openrouter.ai/api/v1/chat/completions";

// –ú–æ–¥–µ–ª—å Claude 4.5 Sonnet –Ω–∞ OpenRouter (–∫–∞–∫ –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ)
// –í OpenRouter –æ–Ω–∞ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏–º–µ–Ω–Ω–æ —Ç–∞–∫:
//   model: "anthropic/claude-sonnet-4.5"
const MODEL = "anthropic/claude-sonnet-4.5";

function sleep(ms: number): Promise<void> {
  return new Promise((resolve) => setTimeout(resolve, ms));
}

/**
 * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–ø–∏—Å–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ —á–µ—Ä–µ–∑ Claude 3.5 Sonnet –Ω–∞ OpenRouter
 * –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏ –ø—Ä–æ–º–ø—Ç—ã –∏–∑ Replicate –≤–µ—Ä—Å–∏–∏
 */
export async function generateProductDescription(
  productName: string,
  userPreferences: string = "",
  selectedBlocks: string[] = [],
  photoUrl?: string,
  style: 1 | 2 | 3 | 4 = 1,
  wantsStickers: boolean = false,
  baseDescription?: string
): Promise<string> {
  const styleNames = { 1: "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π", 2: "–ü—Ä–æ–¥–∞—é—â–∏–π", 3: "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π", 4: "–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π" };
  console.log(`üîÑ [–°–¢–ò–õ–¨ ${style}] –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ —á–µ—Ä–µ–∑ Claude 4.5 Sonnet –Ω–∞ OpenRouter (${styleNames[style]})...`);
  console.log(`üîÑ [–°–¢–ò–õ–¨ ${style}] –¢–æ–≤–∞—Ä: "${productName}"`);
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∏–ª—å –æ–ø–∏—Å–∞–Ω–∏—è (–¢–û–ß–ù–û –¢–ê–ö –ñ–ï, –∫–∞–∫ –≤ Replicate –≤–µ—Ä—Å–∏–∏)
  const stylePrompts = {
    1: "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π/—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π: —Ñ–æ–∫—É—Å –Ω–∞ —Ñ–∞–∫—Ç–∞—Ö –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞—Ö, –Ω–æ –±–µ–∑ —Å—É—Ö–æ—Å—Ç–∏. –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —è–∑—ã–∫, –∫–∞–∫ –±—É–¥—Ç–æ —ç–∫—Å–ø–µ—Ä—Ç —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç –æ —Ç–æ–≤–∞—Ä–µ.",
    2: "–ü—Ä–æ–¥–∞—é—â–∏–π/—ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π: –ø–æ–∫–∞–∂–∏ –≤—ã–≥–æ–¥—ã –∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞, –Ω–æ –±–µ–∑ –∏–Ω—Ñ–æ—Ü—ã–≥–∞–Ω—Å—Ç–≤–∞. –ß–µ—Å—Ç–Ω–æ –∏ —É–±–µ–¥–∏—Ç–µ–ª—å–Ω–æ, –∫–∞–∫ —Ö–æ—Ä–æ—à–∏–π –ø—Ä–æ–¥–∞–≤–µ—Ü –≤ –º–∞–≥–∞–∑–∏–Ω–µ.",
    3: "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π: —á–µ—Ç–∫–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è, —Å–ø–∏—Å–∫–∏ –∏ –∞–∫—Ü–µ–Ω—Ç—ã, –Ω–æ –Ω–µ —à–∞–±–ª–æ–Ω–Ω–æ. –ö–∞–∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ–±–∑–æ—Ä –æ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.",
    4: "–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π: –∫–æ–º–±–∏–Ω–∞—Ü–∏—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤. –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–∞—Å—Å–∫–∞–∑ –æ —Ç–æ–≤–∞—Ä–µ, –∫–∞–∫ –±—É–¥—Ç–æ –¥—Ä—É–≥ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç —á—Ç–æ-—Ç–æ —Ö–æ—Ä–æ—à–µ–µ.",
  };
  
  const styleDescription = stylePrompts[style];
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤ (–¢–û–ß–ù–û –¢–ê–ö –ñ–ï)
  const blocksText = selectedBlocks.length > 0
    ? `\n–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∏ –≤ –æ–ø–∏—Å–∞–Ω–∏–µ:\n${selectedBlocks.map(b => `- ${b}`).join("\n")}`
    : "";
  
  // –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è Claude (–¢–û–ß–ù–û –¢–ê–ö –ñ–ï, –∫–∞–∫ –≤ Replicate –≤–µ—Ä—Å–∏–∏)
  const systemPrompt = `–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–∏—Å–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ —Ç–∞–∫, –∫–∞–∫ –ø–∏—à–µ—Ç –æ–ø—ã—Ç–Ω—ã–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä-—á–µ–ª–æ–≤–µ–∫.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
- –ü–∏—à–∏ –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫, –∞ –Ω–µ –∫–∞–∫ —à–∞–±–ª–æ–Ω. –ò—Å–ø–æ–ª—å–∑—É–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —è–∑—ã–∫, –∂–∏–≤—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏.
- –ë—É–¥—å —á–µ—Å—Ç–Ω—ã–º –∏ —É–±–µ–¥–∏—Ç–µ–ª—å–Ω—ã–º, –Ω–æ –ù–ï –∏–Ω—Ñ–æ—Ü—ã–≥–∞–Ω—å. –ù–∏–∫–∞–∫–∏—Ö "–†–ï–í–û–õ–Æ–¶–ò–û–ù–ù–´–• –ü–†–û–†–´–í–û–í", "–ï–î–ò–ù–°–¢–í–ï–ù–ù–´–• –í –°–í–û–ï–ú –†–û–î–ï", "–ú–ï–ù–Ø–ï–¢ –ñ–ò–ó–ù–¨".
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –≥—Ä–æ–º–∫–∏–µ —Å–ª–æ–≥–∞–Ω—ã –∏ –∫–ª–∏—à–µ —Ç–∏–ø–∞ "–∫–∞—á–µ—Å—Ç–≤–æ –ø—Ä–µ–º–∏—É–º", "–Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–∞—è –≤—ã–≥–æ–¥–∞", "–ª—É—á—à–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ".
- –ù–µ –ø–∏—à–∏ —Ç–∞–∫, –±—É–¥—Ç–æ –ø—Ä–æ–¥–∞—ë—à—å –ø–ª–æ—Ö–æ–π —Ç–æ–≤–∞—Ä. –ë—É–¥—å —É–≤–µ—Ä–µ–Ω–Ω—ã–º, –Ω–æ –Ω–µ –Ω–∞–≤—è–∑—á–∏–≤—ã–º.
- –§–æ–∫—É—Å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞—Ö –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞—Ö, –ø–æ–¥–∞–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ.
- –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫—É, –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è, —Ä–µ–∞–ª—å–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏.
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–π, –Ω–µ —à–∞–±–ª–æ–Ω–Ω–æ–π "—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏-–ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞-–∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è".
- –ü–∏—à–∏ —Ç–∞–∫, —á—Ç–æ–±—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª—å –∑–∞—Ö–æ—Ç–µ–ª –∫—É–ø–∏—Ç—å, –Ω–æ –Ω–µ —á—É–≤—Å—Ç–≤–æ–≤–∞–ª —Å–µ–±—è –æ–±–º–∞–Ω—É—Ç—ã–º.

–°—Ç–∏–ª—å: –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –Ω–æ –∂–∏–≤–æ–π. –ö–∞–∫ —Ö–æ—Ä–æ—à–∏–π –ø—Ä–æ–¥–∞–≤–µ—Ü, –∫–æ—Ç–æ—Ä—ã–π –∑–Ω–∞–µ—Ç —Ç–æ–≤–∞—Ä –∏ —á–µ—Å—Ç–Ω–æ –æ –Ω—ë–º —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç.`;

  // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¢–û–ß–ù–û –¢–ê–ö –ñ–ï)
  const baseTextBlock = baseDescription
    ? `–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç (–ø–µ—Ä–µ–ø–∏—à–∏ –µ–≥–æ, —Å—Ç—Ä–æ–≥–æ —É—á–∏—Ç—ã–≤–∞—è –≤—Å–µ –ø—Ä–∞–≤–∫–∏):\n\"\"\"\n${baseDescription}\n\"\"\"`
    : "";

  const userPrompt = `–ù–∞–ø–∏—à–∏ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ (Ozon, Wildberries).

–¢–æ–≤–∞—Ä: ${productName}
${userPreferences ? `–ü–æ–∂–µ–ª–∞–Ω–∏—è: ${userPreferences}` : ""}
${blocksText}
${baseTextBlock ? `\n${baseTextBlock}\n` : ""}

–°—Ç–∏–ª—å: ${styleDescription}

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –ü–û –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Æ:
- –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π markdown-—Ö—ç—à—Ç–µ–≥–∏ (# –∏–ª–∏ ##) –≤ —Ç–µ–∫—Å—Ç–µ
- –î–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç —Å –¥–≤–æ–µ—Ç–æ—á–∏–µ–º –≤ –∫–æ–Ω—Ü–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:" –∏–ª–∏ "–î–ª—è –∫–æ–≥–æ –ø–æ–¥–æ–π–¥—ë—Ç:")
- –î–ª—è —Å–ø–∏—Å–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç—ã–µ —Å–∏–º–≤–æ–ª—ã: –¥–µ—Ñ–∏—Å (-) –∏–ª–∏ —Ç–æ—á–∫–∞ —Å –∑–∞–ø—è—Ç–æ–π (‚Ä¢)
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Å–∏–º–≤–æ–ª—ã ‚Üí –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Å–ª–æ–∂–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ —Å–ø–∏—Å–∫–∞—Ö - –æ–Ω–∏ –º–æ–≥—É—Ç –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ Ozon
- –ú–µ–∂–¥—É –∞–±–∑–∞—Ü–∞–º–∏ –æ—Å—Ç–∞–≤–ª—è–π –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
- –ò—Å–ø–æ–ª—å–∑—É–π –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫

${wantsStickers ? `–í–ê–ñ–ù–û: –î–æ–±–∞–≤—å –ø—Ä–æ—Å—Ç—ã–µ —ç–º–æ–¥–∑–∏ (—Å—Ç–∏–∫–µ—Ä—ã) –≤ –æ–ø–∏—Å–∞–Ω–∏–µ –≥–¥–µ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–π: ‚úì, ‚òÖ, üéÅ, ‚ù§Ô∏è, üî•, ‚ú®\n- –ò—Å–ø–æ–ª—å–∑—É–π –∏—Ö —É–º–µ—Ä–µ–Ω–Ω–æ, –Ω–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤ —Ç–µ–∫—Å—Ç\n- –†–∞–∑–º–µ—â–∞–π –∏—Ö —Ç–∞–º, –≥–¥–µ —ç—Ç–æ —É–ª—É—á—à–∞–µ—Ç –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ‚úì –ø–µ—Ä–µ–¥ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞–º–∏, ‚òÖ –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–æ–≤, üéÅ –¥–ª—è –ø–æ–¥–∞—Ä–∫–æ–≤)` : `- –ë–ï–ó —ç–º–æ–¥–∑–∏ –∏ —Å—Ç–∏–∫–µ—Ä–æ–≤ (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –∏–Ω–æ–µ –≤ –ø–æ–∂–µ–ª–∞–Ω–∏—è—Ö)`}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- 200-500 —Å–ª–æ–≤
- –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —è–∑—ã–∫, –∫–∞–∫ –æ—Ç –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä–∞-—á–µ–ª–æ–≤–µ–∫–∞
- –ë–µ–∑ —à–∞–±–ª–æ–Ω–æ–≤ –∏ –∫–ª–∏—à–µ
- –ë–µ–∑ –≥—Ä–æ–º–∫–∏—Ö —Å–ª–æ–≥–∞–Ω–æ–≤
- –ß–µ—Å—Ç–Ω–æ –∏ —É–±–µ–¥–∏—Ç–µ–ª—å–Ω–æ
- –†—É—Å—Å–∫–∏–π —è–∑—ã–∫
- –ñ–∏–≤–æ–π, –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ç–µ–∫—Å—Ç, –Ω–µ —Å—É—Ö–æ–π

–ù–∞–ø–∏—à–∏ –æ–ø–∏—Å–∞–Ω–∏–µ:`;

  try {
    console.log(`üîÑ [–°–¢–ò–õ–¨ ${style}] –ó–∞–ø—É—Å–∫–∞–µ–º streaming –∑–∞–ø—Ä–æ—Å –∫ OpenRouter...`);
    console.log(`üîÑ [–°–¢–ò–õ–¨ ${style}] –î–ª–∏–Ω–∞ –ø—Ä–æ–º–ø—Ç–∞: ${userPrompt.length} —Å–∏–º–≤–æ–ª–æ–≤`);
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –¥–ª—è OpenRouter (—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å OpenAI API)
    const requestBody = {
      model: MODEL,
      messages: [
        {
          role: "system",
          content: systemPrompt,
        },
        {
          role: "user",
          content: userPrompt,
        },
      ],
      stream: true,
      temperature: 0.7,
      max_tokens: 2000,
    };

    // –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å —Å retry –ª–æ–≥–∏–∫–æ–π
    let stream: ReadableStream<Uint8Array> | null = null;
    let streamAttempts = 0;
    const maxStreamAttempts = 3;

    while (streamAttempts < maxStreamAttempts) {
      try {
        console.log(`üîÑ [–°–¢–ò–õ–¨ ${style}] –°–æ–∑–¥–∞–µ–º streaming –∑–∞–ø—Ä–æ—Å (–ø–æ–ø—ã—Ç–∫–∞ ${streamAttempts + 1}/${maxStreamAttempts})...`);
        
        const response = await fetch(OPENROUTER_API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
            "HTTP-Referer": process.env.NEXT_PUBLIC_APP_URL || "https://karto.app",
            "X-Title": "KARTO - Product Description Generator",
          },
          body: JSON.stringify(requestBody),
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error(`‚ùå [–°–¢–ò–õ–¨ ${style}] OpenRouter API error: ${response.status} - ${errorText}`);
          
          // –ï—Å–ª–∏ —ç—Ç–æ rate limit, –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
          if (response.status === 429) {
            streamAttempts++;
            const retryAfter = response.headers.get("retry-after");
            const delay = retryAfter ? parseInt(retryAfter) * 1000 : 10000;
            console.log(`‚è≥ [–°–¢–ò–õ–¨ ${style}] Rate limit (429), –∂–¥–µ–º ${delay/1000}s –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º...`);
            await sleep(delay);
            continue;
          }
          
          throw new Error(`OpenRouter API error: ${response.status} - ${errorText}`);
        }

        if (!response.body) {
          throw new Error("Response body is null");
        }

        stream = response.body;
        console.log(`üîÑ [–°–¢–ò–õ–¨ ${style}] Streaming –æ–±—ä–µ–∫—Ç —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!`);
        break;
      } catch (streamError: any) {
        streamAttempts++;
        const isRateLimit = streamError.message?.includes("429") || 
                            streamError.message?.includes("rate limit");
        
        if (isRateLimit && streamAttempts < maxStreamAttempts) {
          const delay = 10000 * streamAttempts; // 10s, 20s, 30s
          console.log(`‚è≥ [–°–¢–ò–õ–¨ ${style}] Rate limit, –∂–¥–µ–º ${delay/1000}s –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º...`);
          await sleep(delay);
          continue;
        }
        
        throw streamError;
      }
    }

    if (!stream) {
      throw new Error(`[–°–¢–ò–õ–¨ ${style}] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å streaming –ø–æ—Å–ª–µ ${maxStreamAttempts} –ø–æ–ø—ã—Ç–æ–∫`);
    }

    console.log(`üîÑ [–°–¢–ò–õ–¨ ${style}] Streaming –æ–±—ä–µ–∫—Ç —Å–æ–∑–¥–∞–Ω, –Ω–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É...`);

    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º streaming –æ—Ç–≤–µ—Ç
    let fullText = "";
    let eventCount = 0;
    const reader = stream.getReader();
    const decoder = new TextDecoder();

    try {
      while (true) {
        const { done, value } = await reader.read();
        
        if (done) {
          console.log(`üîÑ [–°–¢–ò–õ–¨ ${style}] –°—Ç—Ä–∏–º –∑–∞–≤–µ—Ä—à–µ–Ω. –ü–æ–ª—É—á–µ–Ω–æ ${eventCount} —á–∞–Ω–∫–æ–≤.`);
          break;
        }

        eventCount++;
        if (eventCount === 1) {
          console.log(`üîÑ [–°–¢–ò–õ–¨ ${style}] ‚úÖ –ü–æ–ª—É—á–µ–Ω–æ –ø–µ—Ä–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ —Å—Ç—Ä–∏–º–∞!`);
        }
        if (eventCount % 10 === 0) {
          console.log(`üîÑ [–°–¢–ò–õ–¨ ${style}] –ü–æ–ª—É—á–µ–Ω–æ ${eventCount} —á–∞–Ω–∫–æ–≤, —Ç–µ–∫—É—â–∞—è –¥–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞: ${fullText.length}`);
        }

        // –î–µ–∫–æ–¥–∏—Ä—É–µ–º —á–∞–Ω–∫
        const chunk = decoder.decode(value, { stream: true });
        const lines = chunk.split("\n");

        for (const line of lines) {
          if (line.startsWith("data: ")) {
            const data = line.slice(6);
            if (data === "[DONE]") {
              continue;
            }

            try {
              const parsed = JSON.parse(data);
              const content = parsed.choices?.[0]?.delta?.content;
              if (content) {
                fullText += content;
              }
            } catch (e) {
              // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å—Ç—Ä–æ–∫
            }
          }
        }
      }
    } catch (streamError: any) {
      console.error(`‚ùå [–°–¢–ò–õ–¨ ${style}] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å—Ç—Ä–∏–º–∞ (–ø–æ–ª—É—á–µ–Ω–æ ${eventCount} —á–∞–Ω–∫–æ–≤):`, streamError?.message || streamError);
      console.error(`‚ùå [–°–¢–ò–õ–¨ ${style}] Stack trace:`, streamError?.stack);
      throw streamError;
    } finally {
      reader.releaseLock();
    }

    console.log(`üîÑ [–°–¢–ò–õ–¨ ${style}] –°—Ç—Ä–∏–º –∑–∞–≤–µ—Ä—à–µ–Ω. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç...`);
    const description = fullText.trim();

    if (!description || description.length < 50) {
      console.warn(`‚ö†Ô∏è [–°–¢–ò–õ–¨ ${style}] –û–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ (${description.length} —Å–∏–º–≤–æ–ª–æ–≤), –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∞–∑–æ–≤–æ–µ`);
      return `–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ "${productName}". –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä –¥–ª—è –≤–∞—à–∏—Ö –Ω—É–∂–¥.`;
    }

    console.log(`‚úÖ [–°–¢–ò–õ–¨ ${style}] –û–ø–∏—Å–∞–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ Claude 4.5 Sonnet –Ω–∞ OpenRouter (${description.length} —Å–∏–º–≤–æ–ª–æ–≤)`);
    return description;

  } catch (error: any) {
    const errorMessage = String(error?.message || error || "");
    console.error(`‚ùå [–°–¢–ò–õ–¨ ${style}] –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ OpenRouter:`, errorMessage);
    console.error(`‚ùå [–°–¢–ò–õ–¨ ${style}] Stack trace:`, error?.stack);
    throw error;
  }
}
